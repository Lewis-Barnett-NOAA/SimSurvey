---
title: "Using simulation to optimize the sampling design of fisheries-independent trawl surveys"
author: "Paul M. Regular & Fran Mowbray"
date: "September 6^th^, 2018"
output:
  ioslides_presentation:
    widescreen: true
    incremental: true
    logo: dfo_logo.png
    css: dfo_style.css
bibliography: references.bib
---

<style>

@import url('https://fonts.googleapis.com/css?family=Montserrat');

.forceBreak { -webkit-column-break-after: always; break-after: column; }

</style>


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      message = FALSE,
                      warning = FALSE, 
                      fig.width = 10, 
                      fig.height = 5.2)
knitr::opts_knit$set(root.dir = "../..")
```


```{r data, include = FALSE}
library(SimSurvey)
library(plotly)
library(crosstalk)
library(raster)
library(lattice)
library(viridis)
library(data.table)
load("analysis/cod_sim_exports/2018-07-13_test/test_output.RData")

boat_txt <- '<br>
<img src="graphics/teleost_twitter_crop.jpg" width="400"/>
<font size="1"> 
<br>
&nbsp; <a href="https://twitter.com/coastguardcan/status/879410397790515201">Canadian Coast Guard | Twitter</a>
</font>'

## wrapper for layout with some different defaults for this slideshow
tight_layout <- function(p, 
                         plot_bgcolor = "transparent",
                         paper_bgcolor = "transparent",
                         margin = list(l = 0, r = 0, t = 0, b = 0, pad = 0),
                         font = list(size = 14, family = "'Montserrat', sans-serif"), 
                         ..., data = NULL) {
  layout(p, plot_bgcolor = plot_bgcolor, paper_bgcolor = paper_bgcolor,
         margin = margin, font = font, ..., data = data)
}

```


## Fisheries-independent trawl surveys {.columns-2}

- Conducted by many RFMOs
- Becoming increasingly important in stock assessment
- Very costly üí∞
- General goal:
    - Maximize information & minimize expenses

<p class="forceBreak"></p>

```{r results = "asis"}
cat(boat_txt)
```


## Fisheries-independent trawl surveys {.columns-2}

- How much survey effort is enough?
    - Difficult to answer
        - Multi-stage sampling
        - Intra-haul correlation

<p class="forceBreak"></p>

```{r results = "asis"}
cat(boat_txt)
```


## Multi-stage sampling

Surveys are generally designed to:

<font size="8"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 </font> | <font size="8"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2 </font> | <font size="8"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 3 </font>
:----: | :----: | :----:
Conduct sets at multiple locations | Sub-sample catch for length measurements | Sub-sampling length groups for age determination
<img src="graphics/trawl_survey_crop.jpg" height="180"/> | <img src="graphics/cod_length.jpg" height="120"/> | <img src="graphics/Otoliths2_crop.jpg" height="140"/>


## Intra-haul correlation

Sampling clusters of fish that have similar characteristics (e.g. length)

- Results in samples with positive intra-haul correlation
    - Reduces effective sample size

<center> <img src="graphics/plos_figure_crop.png" height="300"/>
<br>
<font size="1">
Graphic from <a href="http://journals.plos.org/ploscompbiol/article?id=10.1371/journal.pcbi.1002915">Tunstr√∏m et al (2013) PLoS Comput Biol 9(2): e1002915.</a>
</font>
</center>

## Fisheries-independent trawl surveys {.columns-2}

- How much survey effort is enough?
    - Attempt to answer using:
        - Sub-sampling
            - Based in reality
            - Truth unknown
        - Simulation
            - Truth known
            - Reality?

<p class="forceBreak"></p>

```{r results = "asis"}
cat(boat_txt)
```


## **Reality is complicated** {data-background=graphics/school_light.png data-background-size=cover}

- **Dynamic abundance**
- **Spatial aggregation**
- **Survey design**
- **_Objective: build a simulation that emulates reality_**


## Simulate abundance

- Common cohort model
    - $N_{a,y} = N_{a-1,y-1} e^{-Z_{a-1,y-1}}$
- First year filled via exponential decay
    -  $N_{a,1} = N_{a-1,1} e^{-Z_{a-1,1}}$
- Random-walk in recruitment
    - $log(N_{1,y}) = log(\mu_r) + \epsilon_{y}$, where $\epsilon_{y} \sim N(\epsilon_{y - 1}, \sigma_{r}^{2})$
- Total mortality correlated across ages and years
    - $log(Z_{a,y}) = log(\mu_Z) + \delta_{a,y}$, where $\delta_{a,y} \sim N(0, \Sigma_{a,y})$
        - Using covariance, $\Sigma_{a,y}$, described in Cadigan [-@Cadigan2016]

## Simulate abundance {.tighter}

### Trend in total abundance

<dev class = "left">
```{r}
plot_trend(sim) %>% 
  tight_layout(yaxis = list(rangemode = "tozero"),
               margin = list(l = 70, r = 0, t = 0, b = 40, pad = 0))
```
</dev>

## Simulate abundance {.tighter}

### Trend in abundance at age

<dev class = "left">
```{r}
plot_surface(sim) %>% tight_layout()
```
</dev>

## Simulate spatial aggregation

- Generate a square grid of $s$ locations, resolution $R$ and a depth gradient
- Distribute population through space and add spatial-temporal noise
    - $log(N_{a,y,s}) = log(N_{a,y}) + \eta_{a,y,s}$
    - $\eta_{a,y,s}$ includes parabolic relationship with depth and covariance between ages, years and space
        - $\eta_{a,y,s} = \frac{(d_s - \mu_{d}) ^ 2}{2 \sigma_d^2} + \xi_{a,y,s}$
        - $\xi_{a,y,s}$ is a combination of Mat√©rn covariance and the age-year covariance described in Cadigan [-@Cadigan2016]


## Simulate spatial aggregation  {.tighter}

### Square grid with depth gradient

<dev class = "left">
```{r}
plot_ly(data = sim$grid_xy, x = ~x, y = ~y, color = ~depth, 
        symbol = I(15), size = I(4.5), name = "grid", type = "scatter", 
        text = ~depth) %>%
  colorbar(title = "Depth") %>%
  tight_layout(yaxis = list(title = "", scaleanchor = "x", zeroline = FALSE, 
                            showgrid = FALSE, showticklabels = FALSE,
                            tickcolor = "transparent"),
               xaxis = list(title = "", zeroline = FALSE, 
                            showgrid = FALSE, showticklabels = FALSE,
                            tickcolor = "transparent"))
```
</dev>


## Simulate spatial aggregation {.tighter}

### Distribution for ages 1-6 in years 1-6

<dev class = "left">
```{r}
plot_distribution_slider(sim, ages = 1:6, years = 1:6) %>% 
  tight_layout(margin = list(l = 0, r = 0, t = 40, b = 0, pad = 0))
```
</dev>


## Simulate survey

- Split grid into $N_{div}$ divisions and $N_{strat}$ depth-based strata
- Set allocation defined by specifying set density, $D_{sets}$
- Binomial sampling was used to simulate catch:
    - $n_{a,y,s} \sim Bin(N_{a,y,s}, \frac{A_{trawl}}{A_{cell}} q_a )$
    - Accounts for trawl size relative to cell size, $\frac{A_{trawl}}{A_{cell}}$, and catchability, $q_a$ (controled using a logistic curve)
    
## Simulate survey

- Lengths simulated using the original von Bertalanffy growth curve [@Cailliet2006]:
    - $log(l) = log(l_{\infty} - (l_{\infty} - l_0) e^{-Ka}) + \varepsilon$, where $\varepsilon \sim N(0, \sigma_{l}^2)$
- Sub-sampling is then conducted
    - A maximum number of lengths are measured per set, $M_{lengths}$
    - A maximum number of ages, $M_{ages}$, are sampled per length group, $l_{group}$, per division


## Simulate survey {.tighter}

### Catch in year 1 survey simulation 1

<dev class = "left">
```{r}
plot_samp_dist(sim) %>% 
  tight_layout(margin = list(l = 0, r = 0, t = 0, b = 40, pad = 0))
```
</dev>

## Settings and analysis {.build}

- Roughly based simulation on 3Ps Cod
- A series of 175 surveys were tested

|      **Parameter name** |      **Symbol** |                                       **Setting** |
|:----------------------- | :-------------- | :------------------------------------------------ |
|             Set density |      $D_{sets}$ |    0.0005, 0.001, 0.002, 0.005, 0.01 sets / km^2^ |
|  Length sampling effort |   $M_{lengths}$ |       5, 10, 20, 50, 100, 500, 1000 lengths / set |
|     Age sampling effort |      $M_{ages}$ |   2, 5, 10, 20, 50 ages / length group / division |


## Settings and analysis

- Each survey was run 1000 times over the same population
- Abundance estimates, $\hat{I}_{a,y,k}$, were obtained using a stratified analysis [@Smith1981]
- Used root-mean-squared error (RMSE) as a measure of the precision and bias of the abundance estimates from each survey:
    - $RMSE = \sqrt{\frac{ \sum_{a = 1}^{N_a} \sum_{y = 1}^{N_y} \sum_{k = 1}^{N_k} (\hat{I}_{a,y,k} - I_{a,y})}{N_a N_y N_k}}$
    - Where $I_{a,y}$ is the true abundance available to the survey
- Powered by R and worked into a package (https://github.com/PaulRegular/SimSurvey)


## Truth vs. estimate

### Total abundance

<dev class = "left">
```{r}
plot_total_strat_fan(sim, surveys = 1:5, 
                     plot_bgcolor = "transparent", paper_bgcolor = "transparent",
                     font = list(size = 14, family = "'Montserrat', sans-serif"))
```
</dev>

## Truth vs. estimate

### Abundance at age

<dev class = "left">
```{r}
surveys <- sim$surveys[set_den %in% c(0.0005, 0.001, 0.002, 0.01) &
                         lengths_cap %in% c(10, 100, 500, 1000) &
                         ages_cap %in% c(5, 10, 50), ]
plot_age_strat_fan(sim, surveys = surveys$survey, 
                   years = 1:5, ages = sim$ages, select_by = "year",
                   plot_bgcolor = "transparent", paper_bgcolor = "transparent",
                   font = list(size = 14, family = "'Montserrat', sans-serif"))
```
</dev>


## Truth vs. estimate

### Abundance at age

<dev class = "left">
```{r}
plot_age_strat_fan(sim, surveys = surveys$survey, 
                   ages = 2:6, years = sim$years, select_by = "age",
                   plot_bgcolor = "transparent", paper_bgcolor = "transparent",
                   font = list(size = 14, family = "'Montserrat', sans-serif"))
```
</dev>


## Truth vs. estimate {.tighter}

### RMSE

<dev class = "left">
```{r}
plot_error_surface(sim) %>% tight_layout()
```
</dev>

## Truth vs. estimate {.smaller}

### Recap

- **Sets = primary sampling unit**
    - Only way to improve stratified estimates of total abundance
    - Best way to improve stratified estimates of abundance at age
- **Increasing length sampling does not always improve estimates**
    - At low set densities, more is worse
    - At high set densities, more is better
- **Sampling effort affects both bias and percision**
    - Stratified estimates are supposed to be unbiased?!
    - Likely related to age-specific clustering
    
## Check bias

### Turned off age-specific clustering

<dev class = "left">
```{r}
load("analysis/cod_sim_exports/2018-07-16_test/test_output.RData")
plot_age_strat_fan(sim, surveys = surveys$survey,
                   ages = 2:6, years = sim$years, select_by = "age",
                   plot_bgcolor = "transparent", paper_bgcolor = "transparent",
                   font = list(size = 14, family = "'Montserrat', sans-serif"))
```
</dev>


## Check bias {.tighter}

### Turned off age-specific clustering

<dev class = "left">
```{r}
plot_error_surface(sim) %>% tight_layout()
```
</dev>


## Acknowledgements

- Todo


<!-- There is a conflict somewhere...had to contain plotly plots in a dev to get it working and I had to add a bunch of spaces to fudge centering in one of the tables -->

## References {.smaller}

