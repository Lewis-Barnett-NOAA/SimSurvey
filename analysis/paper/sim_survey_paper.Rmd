---
title: "`SimSurvey`: an `R` package to optimize the design and analysis of fisheries surveys by simulating spatially-correlated fish stocks"
author: "Paul M. Regular, Gregory J. Robertson, Keith P. Lewis, Jonathan Babyn, Fran Mowbray, etc.?"
date: "Fisheries and Oceans Canada, Northwest Atlantic Fisheries Center, 80 East White Hills, St. John's, Newfoundland and Labrador, A1C 5X1, Canada"
output: 
  bookdown::word_document2:
    reference_docx: template.docx
bibliography: references.bib
csl: ices-journal-of-marine-science.csl
---

```{r setup, include=FALSE}

# devtools::install_github("rstudio/rmarkdown@v1.10")
knitr::opts_chunk$set(echo = FALSE,
                      message = FALSE,
                      warning = FALSE,
                      dev = "png",
                      dpi = 300)
knitr::opts_knit$set(root.dir = "../..")
options(scipen = 999) # turn off scientific notation to simplify printing

```


```{r packages, include = FALSE}

library(SimSurvey)
library(plotly)
library(raster)
library(lattice)
library(viridis)
library(data.table)
library(magrittr)
Sys.setenv("MAPBOX_TOKEN" = "pk.eyJ1IjoicGF1bHJlZ3VsYXIiLCJhIjoiY2pueGIxejMxMGM0MjNqbjR1aXdwYm92bSJ9.R-t1SCa0VHKf4N-PQmYI5Q")
source("analysis/paper/helper_functions.R")

replot <- FALSE # plot the figures again? (acts as a manual cache)

```


<!-- Items to discuss -->
<!-- - Title -->
<!-- - Target journal -->
<!-- - Actual figures in appendix (html article, with interactive figures, as supplement?) -->


# Summary

**1\.** Age-structured fish stocks often show complex spatial and temporal dynamics, creating challenges in designing and implementing effective population surveys. Inappropriate sampling designs can potentially lead to both under-sampling (reducing precision and increasing the risk of bias) and over-sampling (through the extensive and potentially expensive sampling of correlated metrics).

**2\.** For assessments based on fisheries-independent surveys, the ability to estimate population parameters is affected by multiple levels of sampling, such as the number of fishing sets as well as the sub-sampling of fish captured to measure biological characteristics (e.g. lengths or ages). Population estimates are also affected by the pathway taken to analyze such data.

**3\.** Though simulations are a useful tool for exploring the efficacy of specific sampling strategies and statistical methods, there are a limited the number of tools that facilitate the simulation testing of a range of sampling and analytical pathways for fisheries-independent survey data.

**4\.** Here we introduce the `R` package **`SimSurvey`**, which has been designed to simplify the process of simulating surveys of age-structured and spatially-distributed fish populations. The package allows the user to simulate age-structured populations that vary in space and time and explore the efficacy of a range of sampling protocols to reproduce the population parameters of the known population. **`SimSurvey`** also include a function for running a stratified-random analysis of the simulated data.

**5\.** **`SimSurvey`** can serve as a convenient, accessible and flexible platform for simulating a wide range of sampling strategies for fish stocks that show complex structuring. Various statistical approaches can then be applied to the results to test the efficacy of different analytical approaches.

**Key-words:** length and age distribution; simulation; spatial correlation; stratified analysis; survey design


# Introduction

Fisheries-independent surveys have become a mainstay in the management of dynamic fish stocks as they provide indices of population abundance as well as estimates of various population characteristics such as length and age frequencies. While costly to obtain, this information forms the basis of many stock assessments throughout the world [@Pennington1998]. Efficient and informed management decisions therefore require surveys and analyses that maximize information while minimizing the expense of data collection. While simulations provide a platform for exploring solutions to this optimization problem, building the necessary simulation framework is not a trivial task given the multi-stage nature of the typical sampling program and the complexity of the population processes we aim to represent. Notably, many fish stocks show size-specific patterns of aggregation, making it difficult to collect biological sub-samples (e.g. lengths and ages) that are representative of the entire target population. This undermines the assumptions of many analyses as sub-samples from such populations tend to exhibit strong positive intracluster correlation [@Aanes2015]. These complexities may explain why simulations that test the full sampling and analytical pathway of fisheries-independent surveys are rare [but see @puerta2019; @schnute2003].

Here we document **`SimSurvey`**, an `R` package designed to simplify and facilitate realistic simulations of fisheries-independent trawl surveys. In short, the package allows for the simulation of random or stratified-random surveys of an age-structured population that varies in space and time. The package has two main components: the first focuses on mimicking realistic fish stocks by simulating a spatially and age-correlated population distributed across a habitat gradient, and the second component focuses on simulating various surveys of these virtual fish stocks. 

This simulation framework has similarities to those presented by Schnute and Haigh [-@schnute2003] and Puerta et al. [-@puerta2019], however, efforts were focused on developing a series of general and accessible functions to simplify the process of testing multiple sampling scenarios and analytical pathways. The steps taken to simulate surveys of spatial, age-structure populations are outlined below. While the core of this paper focuses on how to use this package, it is important to note that the defaults of the package are based on a case study. Output from default function calls are therefore relavant to the case study and these results are described and discussed in [*Appendix A*][Appendix A: Case study].

# The **`SimSurvey`** package

The **`SimSurvey`** package was written in the programming language `R` [@R] and it holds a series of functions for 1) simulating the abundance and distribution of virtural fish populations with correlation across space, time and age, 2) simulating surveys with a range of sampling stratigies and intensities, and 3) running stratified analyses of simulated survey data (Table \@ref(tab:fun)). The equations behind these functions are detailed in the sections below. **`SimSurvey`** relies heavily on functions from the **`data.table`** [@dowle2017], **`raster`** [@hijmans2016] and **`plotly`** [@sievert2018] packages for their efficient data processing, geographic and plotting facilities, respectively. Package documentation has been published online using **`pkgdown`** (https://paulregular.github.io/SimSurvey/) and all the source `R` code behind **`SimSurvey`** is available on GitHub (https://github.com/PaulRegular/SimSurvey). **`SimSurvey`** can be installed via GitHub using the **`remotes`** package:

```{r, echo = TRUE, eval = FALSE}
install.packages("remotes")
remotes::install_github("PaulRegular/SimSurvey")
```

Table: (\#tab:fun) Names and descritpions of the key functions of **`SimSurvey`**. Functions in bold font are core functions and those in medium font are designed for use inside the core functions. The latter are typically closures, which are functions that contain data and return functions [@wickham2014]; here they are used to store parameter values and return functions that require dimensions, such as ages or years, to be supplied.

| Function | Description                   |
|:---------|:------------------------------|
| **`sim_abundance`**  | Simulate a basic age-structured population dynamics model |
| `sim_R`, `sim_Z`, `sim_N0`, `sim_vonB` | Closures, to use inside `sim_abundance`, for simulating recruitment, total mortality, initial abundance and growth, respectively | 
| **`sim_distribution`** | Simulate spatial and temporal distribution of an age-structured population |
| `sim_ays_covar`, `sim_parabola` | Closures, to use inside `sim_distribution`, for simulating age-year-space covariance and parabolic relationships with covariates (e.g. depth), respectively |
| `make_grid` | Make a basic depth stratified square grid to use inside `sim_distribution` |
| **`sim_survey`** | Simulate a survey of a spatial, age-structured population |
| `sim_logistic` | Closure, to use inside `sim_survey`, for simulating age-specific catchability as a logistic curve |
| **`run_strat`** | Run a stratified analysis on simulated survey data |
| **`strat_error`** | Calculate the error of stratified estimates (e.g. root mean squared error of stratified estimates from true values) |
| **`test_surveys`** | Test the sampling design of multiple surveys using a stratified analysis (internally loops over `sim_survey`, `run_strat` and `strat_error`) |
| `expand_surveys` | Create a data frame, for use in `test_surveys`,  with all combinations of supplied survey settings |

<br>


## Simulate abundance

The simulation starts with a common cohort model where the abundance at age $a$ in year $y$ ($N_{a,y}$) equals the abundance of that cohort in the previous year multiplied by the survival rate, which is expressed in terms of total mortality ($Z_{a,y}$):

$$N_{a,y} = N_{a-1,y-1} e^{-Z_{a-1,y-1}}$$
Here, numbers at age in the first year are filled via exponential decay, $N_{a,1} = N_{a-1,1} e^{-Z_{a-1,1}}$, numbers at age 1 (i.e. recruits) vary around a baseline value, $log(N_{1,y}) = log(\mu_r) + \epsilon_{y}$, and total mortality is set to a baseline level plus process error, $log(Z_{a,y}) = log(\mu_Z) + \delta_{a,y}$. The error around the recruitment process was set to follow a random walk, $\epsilon_{y} \sim N(\epsilon_{y - 1}, \sigma_{r}^{2})$, and the process error was simulated using the covariance structure described in Cadigan [-@Cadigan2016], $\delta_{a,y} \sim N(0, \Sigma_{a,y})$. The covariance across ages and years is controlled by a process error variance parameter ($\sigma_{\delta}^2$) along with age and year correlation parameters ($\varphi_{\delta, \mathrm{age}}$ and $\varphi_{\delta, \mathrm{year}}$, respectively). This structure allows for autocorrelation in process errors across ages and years (i.e. total mortality can be made to be more similar for fish that are closer together in age and time). Abundance at age is then converted to abundance at length using the original von Bertalanffy growth curve [@von1938]:

$$log(l) = log(l_{\infty} - (l_{\infty} - l_0) e^{-Ka}) + \varepsilon$$

Where $l_{\infty}$ is the mean asymptotic length, $l_0$ is length at birth, $K$ is the growth rate parameter and the error is assumed to follow the normal distribution, $\varepsilon \sim N(0, \sigma_{l}^2)$. Abundance in discrete length groups, $l_{\mathrm{group}}^{N}$, was determined by using this formula to calculate the probability of being within a specific length group given age and then using the resultant length-age-key to convert abundance at age to abundance at length. Overall, this  formulation allows for the simulation of an array of population dynamics that one might expect to observe. 


Table: (\#tab:abundance) Default `sim_abundance` function call, with descriptions and associated parameter symbols of key arguments.

| **Function call**                           | **Description**                                            | **Symbol**                          |
|:------------------------------------------- |:---------------------------------------------------------- | :---------------------------------- |
| `sim_abundance(`                            | &nbsp;                                                     | &nbsp;                              |
| `+  ages = 1:20,`                           | Ages                                                       | $a$                                 |
| `+  years = 1:20,`                          | Years                                                      | $y$                                 |
| `+  R = sim_R(mean = 30000000,`             | Mean recruitment                                           | $\mu_r$                             |
| `+            log_sd = 0.5),`               | Standard deviation of log-recruitment                      | $\sigma_r$                          |
| `+  Z = sim_Z(mean = 0.5,`                  | Mean total mortality                                       | $\mu_Z$                             |
| `+            log_sd = 0.2,`                | Standard deviation of total mortality (log)                | $\sigma_Z$                          |
| `+            phi_age = 0.9,`               | Correlation across ages in error around total mortality    | $\varphi_{\delta, \mathrm{age}}$    |
| `+            phi_year = 0.5),`             | Correlation across years in error around total mortality   | $\varphi_{\delta, \mathrm{year}}$   |
| `+  growth = sim_vonB(Linf = 120,`          | Mean asymptotic length (cm)                                | $l_{\infty}$                        |
| `+                    L0 = 5,`              | Length at birth (cm)                                       | $l_0$                               |
| `+                    K = 0.1,`             | Growth rate                                                | $K$                                 |
| `+                    log_sd = 0.1,`        | Standard deviation of the von Bertalanffy growth curve     | $\sigma_l$                          |
| `+                    length_group = 3))`   | Length group bin size for abundance at length (cm)         | $l_{\mathrm{group}}^{N}$            | 
  
<br>  

Abundance at age and length is simulated using the `sim_abundance` function and a default function call is described in Table \@ref(tab:abundance) along with associated symbols from the equations outlined above. This function has a simple structure and requires the specification of a series of `ages` and `years` along with functions known as "closures", such as `sim_R`, `sim_Z` and `sim_vonB`, for simulating recruitment (`R`), total mortality (`Z`) and growth (`growth`), respectively. Closures are functions that contain data and return functions [@wickham2014] and this structure was chosen to avoid the repeated specifications of ages and years. The use of closures also allows users to construct and use their own closures with a similar structure but different underlying formula. Overall, the function provides a simple tool for simulating a range dynamic age-structured populations. For instance, below we provide examples where we simulate a relatively long and short lived species (note that default variance, starting abundance and growth settings were used in both simulations).

```{r, echo = TRUE, eval = replot}
set.seed(438)
long <- sim_abundance(ages = 1:20,
                      R = sim_R(mean = 3e+07),
                      Z = sim_Z(mean = 0.2))
short <- sim_abundance(ages = 1:6,
                       R = sim_R(mean = 1e+10),
                       Z = sim_Z(mean = 0.8))
```

The `sim_abundance` function returns a list with the sequence of ages (`ages`), sequence of years (`years`), sequence of lengths (`lengths`), numbers of recruits across all years (`R`), numbers at age in the first year (`N0`), total mortality matrix (`Z`), abundance at age matrix (`N`), abundance at length matrix (`N_at_length`) and the function supplied to the `growth` argument (`sim_length`). The growth function is retained for later use in `sim_survey` to simulate lengths given simulated catch at age in a simulated survey.

The package also includes several plotting functions for making quick plotly-based [@sievert2018] interactive visuals of the simulated population. For instance, the `plot_surface` function can be used to make quick visuals of matrices contained within the list returned by `sim_abundance`. As an example, we display the abundance at age matrix (object named `N` in the list produced by `sim_abundance`; Figure \@ref(fig:surface)); other names can be supplied to the `mat` argument to visualize a different matrix from the `sim_abundance` list, such as `Z`.

```{r, echo = TRUE, eval = FALSE}
plot_surface(long, mat = "N")
plot_surface(short, mat = "N")
```


```{r, eval = replot}

pa <- plot_surface(long, mat = "N", scene = "scene1", showscale = FALSE) %>% 
  add_labels(x = 0.05, y = 0.9, text = "a)")
pb <- plot_surface(short, mat = "N", scene = "scene2", showscale = FALSE) %>% 
  add_labels(x = 0.05, y = 0.9, text = "b)")

p <- subplot(pa, pb) %>%
  layout(scene = list(domain = list(x = c(0, 0.5), y = c(0, 1))),
         scene2 = list(domain = list(x = c(0.5, 1), y = c(0, 1)),
                       xaxis = list(title = "Age"),
                       yaxis = list(title = "Year"),
                       zaxis = list(title = "N")))

export_plot(p, file = "analysis/paper/figures/plot_surface.png", width = 800, height = 370)
```


```{r surface, fig.cap = "Surface plots of simulated abundance at age of a relatively a) long lived and b) short lived species. These plots were produced by `plot_surface` when supplied a list produced by `sim_abundance`."}

knitr::include_graphics("figures/plot_surface.png")

```



## Simulate spatial distribution

The next step in the simulation is to distribute the abundance at age matrix simulated using the cohort model throughout a spatial field. Here, a grid of $s$ cells is generated where each cell has an area of $A$ and depth $d$; depth is defined using a sigmoid curve with a depth range of $[d_{\mathrm{min}}, d_{\mathrm{max}}]$, shelf depth of $d_{\mathrm{shelf}}$ and a shelf width of $w_{\mathrm{shelf}}$. The grid is divided into $N_{\mathrm{div}}$ divisions (e.g. NAFO or ICES divisions) and $N_{\mathrm{strat}}$ depth-based strata. The simulated population is distributed through the grid by simulating spatial-temporal noise controlled by a parabolic relationship with depth and covariance between ages, years and space

$$\begin{aligned}log(N_{a,y,s}) &= log(N_{a,y}) + \eta_{a,y,s} \\ \eta_{a,y,s} &= \frac{(d_s - \mu_{d}) ^ 2}{2 \sigma_d^2} + \xi_{a,y,s} \end{aligned}$$

Where $d_s$ is the depth in a specific cell of the grid, $\mu_d$ is the mean depth where abundance is typically highest and $\sigma_d$ controls the width or dispersion of abundance around the mean depth. This helps simulate depth preferences of particular fish. Residual noise $\xi_{a,y,s}$ is added to this depth relationship using a combination of Matérn covariance, to control the level of spatial aggregation within ages and years, and the two dimension AR1 age-year covariance described in Cadigan [-@Cadigan2016], to control the level of similarity in distributions across ages and years. Spatial correlations are controlled by a smoothing ($\lambda$) and a scaling parameter ($\kappa$) [here $\kappa$ is approximated from the range parameter ($r$), $\kappa = \sqrt{8 \lambda} / r$; @Blangiardo2015] and correlation across ages and years is controlled by $\varphi_{\xi, \mathrm{age}}$ and $\varphi_{\xi, \mathrm{year}}$, respectively. The overall variance of the process is controlled by $\sigma_{\xi}^2$ (see [*Appendix B*][Appendix B: Age-year-space covariance] for a more detailed description of the space-age-year covariance structure). In short, this formulation allows control of depth preferences, the level of spatial aggregation and the amount of age and year specific clustering. Note that $\eta_{a,y,s}$ is forced to sum to one in each year to ensure that the total population of each age for each year through the grid equals the number simulated by the cohort model. Also note that numbers were rounded such that a discrete number of fish are in each cell of the grid.  

Table: (\#tab:distribution) Default `sim_distribution` function call, with descriptions and associated parameter symbols of key arguments.

| **Function call**                                       | **Description**                                              | **Symbol**                              |
|:------------------------------------------------------- |:------------------------------------------------------------ | :-------------------------------------- |
| `sim_distribution(`                                     | &nbsp;                                                       | &nbsp;                                  |
| `+  sim,`                                               | Simulated population from `sim_abundance`                    | &nbsp;                                  |
| `+  grid = make_grid(x_range = c(-140, 140),`           | Range of grid in the x dimension                             | &nbsp;                                  |
| `+                   y_range = c(-140, 140),`           | Range of grid in the y dimension                             | &nbsp;                                  |
| `+                   res = c(3.5, 3.5),`                | Grid resolution in x and y dimensions (km) - i.e. cell area  | $A_{\mathrm{cell}}$                     |
| `+                   shelf_depth = 200,`                | Shelf depth (m)                                              | $d_{\mathrm{shelf}}$                    |
| `+                   shelf_width = 100,`                | Shelf width (km)                                             | $w_{\mathrm{shelf}}$                    |
| `+                   depth_range = c(0, 1000),`         | Depth range from coast to slope (m)                          | $[d_{\mathrm{min}}, d_{\mathrm{max}}]$  |
| `+                   n_div = 1,`                        | Number of divisions                                          | $N_{\mathrm{div}}$                      |
| `+                   strat_breaks = seq(0, 1000, 40)),` | Series of depth breaks for defining strata                   | &nbsp;                                  |
| `+  ays_covar = sim_ays_covar(sd = 2.8,`                | Standard deviation of age-year-space distribution            | $\sigma_{\xi}$                          |
| `+                            range = 300,`             | Range of spatial correlation (km)                            | $r$                                     |
| `+                            lambda = 1,`              | Smoothness of spatial correlation                            | $\lambda$                               |
| `+                            phi_age = 0.5,`           | Correlation across ages in spatial distribution              | $\varphi_{\xi, \mathrm{age}}$           |
| `+                            phi_year = 0.9,`          | Correlation across years in spatial distribution             | $\varphi_{\xi, \mathrm{year}}$          |
| `+                            group_ages = 5:20),`      | Make space-age-year variance equal across these ages         | &nbsp;                                  |
| `+  depth_par = sim_parabola(mu = 200,`                 | Depth at which abundance is typically highest (m)            | $\mu_d$                                 |
| `+                           sigma = 70))`              | Dispersion around depth of peak abundance (m)                | $\sigma_d$                              |

<br>

The above equations are used in the `make_grid`, `sim_ays_covar` and `sim_parabola` functions, and these functions are used within `sim_distribution` to distribute a population simulated using `sim_abundance` throughout a grid (Table \@ref(tab:distribution)). The output from `make_grid` is a raster object [@hijmans2016] with four layers: `depth`, `cell`, `division` and `strat`. If a more detailed and realistic grid is required, users can manually generate their own survey grid using real data and this grid can be supplied as a raster to `sim_distribution` if the same structure is used. The package includes a manually constructed survey grid of NAFO Subdivision 3Ps (named `survey_grid`) and the data-raw folder in the GitHub directory includes the data and code used to construct this grid. However, for simplicity, we use `make_grid` to construct a square grid for a default run of `sim_distribution`. Below we generate and plot (Figure \@ref(fig:grid)) a default grid, another grid with the number of strata increased by increasing the number of `strat_splits`, and another with four divisions and a linear depth gradient (the sigmoid curve is forced to be linear when `shelf_width` is set to zero).

```{r, echo = TRUE, eval = FALSE}

a <- make_grid(n_div = 1, strat_splits = 2, shelf_depth = 200,
               shelf_width = 100, depth_range = c(0, 1000))
b <- make_grid(n_div = 1, strat_splits = 3, shelf_depth = 200, 
               shelf_width = 100, depth_range = c(0, 1000))
c <- make_grid(n_div = 4, strat_splits = 1, shelf_depth = 500, 
               shelf_width = 0, depth_range = c(0, 1000))
plot_grid(a)
plot_grid(b)
plot_grid(c)

```


```{r eval = replot}

a <- make_grid() %>% 
  plot_grid(showscale = TRUE) %>% 
  add_labels(x = 0, y = 1, text = "a)")
b <- make_grid(strat_splits = 3) %>% 
  plot_grid(showscale = FALSE) %>% 
  add_labels(x = 0.04, y = 1, text = "b)")
c <- make_grid(n_div = 4, shelf_depth = 500, shelf_width = 0, depth_range = c(0, 1000)) %>% 
  plot_grid(showscale = FALSE) %>% 
  add_labels(x = 0.08, y = 1, text = "c)")
p <- subplot(a, b, c)

export_plot(p, file = "analysis/paper/figures/plot_grid.png", width = 800, height = 320)

```


```{r grid, fig.cap = "Plots produced by `plot_grid` when supplied a raster object produced by `make_grid` a) using default settings, b) settings that increase the number of times depth strata are horizontally split, and c) settings that produce a more linear depth gradient and increase the number of divisions. In these plots, the color gradient represents depth, the thick grey lines delineate divisions and thin white lines delineate strata."}

knitr::include_graphics("figures/plot_grid.png")

```


In addition to supplying objects produced by `sim_abundance` and `make_grid`, the `sim_distribution` function requires two closures that describe the age-year-space covariance and the relationship with depth. Here we use `sim_ays_covar` and `sim_parabola` to control these relationships and a wide range of age and year specific distributions can be obtained by tweaking a few parameters in these closures. Below we run a default `sim_distribution` call, which generates a population that forms tight clusters that are more strongly correlated across years than ages, and another call that generates a population that is more diffuse (i.e. wider `range`) and exhibits stronger correlation across ages than years (i.e. lower `phi_year` and higher `phi_age`). Distributions can also be forced to be the same across ages and years by using the `group_ages` and `group_years` arguments, respectively, in the `sim_ays_covar` closure. Variance in the size of the clusters can also be modified by changing the `sd` argument in the `sim_ays_covar` function. In other words, these parameters can be modified to control the degree of age-specific clustering and inter-annual site-fidelity exhibited by the simulated population. Note that the resolution of the default grid is high and, as such, the simulations below may take minutes to complete. Also note that the key functions in the **`SimSurvey`** package have been set-up to be pipe [`%>%`; @bache2014] friendly.

```{r, echo = TRUE, eval = replot}

set.seed(438)
a <- sim_distribution(sim = sim_abundance(), # nested approach
                      ays_covar = sim_ays_covar(range = 300,
                                                phi_year = 0.9,
                                                phi_age = 0.5))
b <- sim_abundance() %>%  # pipe approach
  sim_distribution(ays_covar = sim_ays_covar(range = 2000,
                                             phi_year = 0.2,
                                             phi_age = 0.9))

```

This function retains all the data simulated by `sim_abundance` and adds a data.table [@dowle2017], named `sp_N`, with abundance (`N`) split by `age`, `year` and `cell`. The function also retains the grid object and converts these data into a data.table, named `grid_xy`, with headers `x`, `y`, `depth`, `cell`, `division` and `strat`. The `sp_N` object can be merged with the `grid_xy` data by `cell` to associate abundance with specific locations, depth, divisions or strata. The `plot_distribution` function can be used to provide a quick visual of the distribution across ages and years. The code below will generate interactive plots with an Age-Year slider, however, for this paper we present a facet plot of the simulated data (Figure \@ref(fig:distribution)).

```{r, echo = TRUE, eval = FALSE}

plot_distribution(a, ages = 1:3, years = 1:3, type = "heatmap")
plot_distribution(b, ages = 1:3, years = 1:3, type = "heatmap")

```


```{r, eval = replot}

facet_distribution <- function(data) {
  ay <- expand.grid(age = 1:3, year = 1:3)
  plot_list <- vector("list", nrow(ay))
  for (i in 1:3) {
    for (j in 1:3) {
      p <- plot_distribution(data, ages = i, years = j, type = "heatmap") %>% 
        hide_colorbar() %>% 
        layout(autosize = FALSE, width = 100, height = 100,
               margin = list(l = 0, r = 0, b = 0, t = 0, pad = 0))
      plot_list[[which(ay$age == i & ay$year == j)]] <- p
    }
  }
  subplot(plot_list, nrows = 3, shareX = TRUE, shareY = TRUE, margin = 0.01) %>% 
    layout(autosize = FALSE, width = 300, height = 300,
           margin = list(t = 20, l = 20, b = 10, r = 10))
} 

a_plots <- facet_distribution(a)
b_plots <- facet_distribution(b)

p <- subplot(a_plots, b_plots) %>% 
  add_labels(text = rep(c("Age 1", "Age 2", "Age 3"), 2), x = c(0.04, 0.20, 0.4, 0.6, 0.8, 0.95), y = rep(0.995, 6), yshift = 20) %>% 
  add_labels(text = rep(c("Year 3", "Year 2", "Year 1"), 2), x = c(rep(0.005, 3), rep(0.54, 3)), y = c(0.08, 0.5, 0.92), xshift = -20, textangle = -90) %>% 
  add_labels(text = "a)", x = 0, y = 1, yshift = 20, xshift = -20) %>% 
  add_labels(text = "b)", x = 0.54, y = 1, yshift = 20, xshift = -20)

export_plot(p, file = "analysis/paper/figures/plot_distribution.png", width = 600, height = 300)

```


```{r distribution, fig.cap = "Distribution plots of simulated populations that form a) tight clusters with stronger correlation through years than ages (default settings), and b) relatively diffuse clusters with stronger correlation through ages than years. This plot is a facet of plots produced by `plot_distribution` when supplied simulations from `sim_distribution`."}

knitr::include_graphics("figures/plot_distribution.png")

```


## Simulate survey

The final step in the simulation is to conduct a stratified random survey over the age-year-space array generated. The area of each strata is calculated and this is used to define the number of sets allocated to each strata under a particular set density, $D_{\mathrm{sets}}$. The allocated number of cells are randomly selected in each strata and the number of fish caught in each set is calculated by applying binomial sampling of the fish in each sampled cell by the proportion of the area covered by the trawl and the catchability of each age:

$$n_{a,y,s} \sim Bin(N_{a,y,s}, \frac{A_{\mathrm{trawl}}}{A_{\mathrm{cell}}} q_a )$$

Where $n_{a,y,s}$ is the number of fish of age `a` in year `y` sampled by a set at location `s`, $A_{\mathrm{trawl}}$ indicates the area covered by the trawl, $A_{\mathrm{cell}}$ is the area of a grid cell, and $q_a$ is the catchability coefficient of each age. Here, catchabilities were defined using a logistic curve controlled by a steepness, $k$, and midpoint parameter, $x_0$. The lengths of the fish sampled by the set are then simulated using the von Bertalanffy growth equation found above in the *[Simulate abundance]* section. Depending on the number of fish caught, sub-sampling is then conducted. Specifically, a maximum number of lengths are measured per set, $M_{\mathrm{lengths}}$, and a maximum number of ages, $M_{\mathrm{ages}}$, are sampled per length group, $l_{\mathrm{group}}$, per division. Such sub-sampling is common in fisheries-independent surveys as it is costly to sample every fish captured. Age determination is especially time-consuming, which is why otoliths for age-determination tend to be sub-sampled by length-bin to obtain a representative age sample across a wider range of lengths than would be obtained via random sampling.

Table: (\#tab:survey) Default `sim_survey` function call, with descriptions and associated parameter symbols of key arguments.

| **Function call**                   | **Description**                                                         | **Symbol**              |
|:----------------------------------- |:----------------------------------------------------------------------- | :---------------------- |
| `sim_survey(`                       | &nbsp;                                                                  | &nbsp;                  |
| `+  sim,`                           | Simulated spatial population from `sim_distribution`                    | &nbsp;                  |
| `+  n_sims = 1`                     | Number of times to repeat the survey                                    | &nbsp;                  |
| `+  q = sim_logistic(k = 2,`        | Steepness of logistic curve of catchability                             | $k$                     |
| `+                   x0 = 3),`      | Midpoint of logistic curve of catchability                              | $x_0$                   |
| `+  trawl_dim = c(1.5, 0.02),`      | Trawl dimensions (length, width; km) - i.e. area covered by a trawl     | $A_{\mathrm{trawl}}$    |
| `+  min_sets = 2`                   | Minimum number of sets to conduct per strata                            | &nbsp;                  |
| `+  set_den = 2/1000,`              | Set density (km^-2^)                                                    | $D_{\mathrm{sets}}$     |
| `+  lengths_cap = 500,`             | Maximum number of lengths to collect / set                              | $M_{\mathrm{lengths}}$  |
| `+  length_group = 1,`              | Length group bin size for age sampling (cm)                             | $l_{\mathrm{group}}$    |
| `+  ages_cap = 10,`                 | Maximum number of ages to sample / length group / division              | $M_{\mathrm{ages}}$     |
| `+  age_sammpling = "stratified")`  | Controls whether age sampling is length `"stratified"` or `"random"`    | &nbsp;                  |

<br>

The function `sim_survey` can be used to simulate data from one survey over a population created using `sim_distribution`. A default function call is described in Table \@ref(tab:survey). The `sim_survey` function simulates the sampling process of the survey and, as such, requires a closure for defining catchability as a function of age and definitions of the design of the survey. Specifically, the `q` argument requires a closure, such as `sim_logistic`, for defining the probability of catching specific age groups, trawl dimensions are defined in the `trawl_dim` argument, and set, length and age sampling effort are defined using the `set_den`, `lengths_cap` and `ages_cap` arguments, respectively. Like `sim_abundance` and `sim_distribution`, custom closures can be supplied to `sim_survey` to impose alternate parametric curves for catchability at age. Multiple simulations of the same survey can be run using the `n_sims` argument, however, requesting large numbers of simulations can be computationally demanding depending on the processing capacity available. Below we use `sim_survey` to simulate two surveys over a default population, of which one is set-up to have higher set density (`set_den`) than the other.

```{r, echo = TRUE, eval = replot}

set.seed(438)
pop <- sim_abundance() %>% 
  sim_distribution()
a <- pop %>% 
  sim_survey(n_sims = 5,
             set_den = 1 / 1000,
             lengths_cap = 100,
             ages_cap = 5)
b <- pop %>% 
  sim_survey(n_sims = 5,
             set_den = 5 / 1000,
             lengths_cap = 500,
             ages_cap = 25)

```

Again, this function retains all the objects listed in the output of `sim_distribution` and adds data.tables that detail the set locations (`setdet`) and sampling details (`samp`). Catchability corrected abundance matrices, named `I` and `I_at_length`, are also produced and added to the output; these matrices are useful for comparing the true abundance available to the survey to abundance estimates obtained using design-based or model-based analyses of the simulated survey data. Specific surveys can be explored using the `plot_survey` function, which uses plotly [@sievert2018] and crosstalk [@cheng2016] in the background to link the bubble plot of aggregate set catch to the histogram of lengths and ages sampled to facilitate explorations of set-specific catches (Figure \@ref(fig:survey)).

```{r, echo = TRUE, eval = FALSE}

plot_survey(a, which_sim = 1, which_year = 20)
plot_survey(b, which_sim = 1, which_year = 20)

```


```{r eval = replot}

plot_a <- plot_survey(a, which_sim = 1, which_year = 20) %>% 
  add_labels(text = "a)", x = 0, y = 1, yshift = 5, xshift = -5) %>% 
  layout(margin = list(l = 10, r = 10, t = 10, b = 10))
plot_b <- plot_survey(b, which_sim = 1, which_year = 20) %>% 
  add_labels(text = "b)", x = 0, y = 1, yshift = 5, xshift = -5) %>% 
  layout(margin = list(l = 10, r = 10, t = 10, b = 10))

## plotly::subplot was not amenable to combining these two plots, I therefore used ImageMagick to combine a and b

paths <- c(a = "analysis/paper/figures/plot_survey_a.png", b = "analysis/paper/figures/plot_survey_b.png")
export_plot(plot_a, file = paths["a"], width = 800, height = 400)
export_plot(plot_b, file = paths["b"], width = 800, height = 400)

image_a <- magick::image_read(paths["a"])
image_b <- magick::image_read(paths["b"])
p <- magick::image_append(c(image_a, image_b), stack = TRUE)
magick::image_write(p, path = "analysis/paper/figures/plot_survey.png")

```


```{r survey, fig.cap = "Bubble plots of abundance and histograms of set catches from a simulated stratified-random survey of a default population under relatively a) low and b) high sampling effort. Point size and color are scaled by abundance in the bubble plots. Histograms of length and age composition include the distribution of all fish caught next to those sampled overlaid with a line of the true distribution of lengths and ages available to the survey. Note that the first simulation of the survey in year 20 is depicted here. These plots are produced by `plot_survey` when supplied survey data simulated using `sim_survey`."}

knitr::include_graphics("figures/plot_survey.png")

```

As noted above, available RAM may limit the utility of the `sim_survey` function for running thousands of simulations of the same survey. The `sim_survey_parallel` function was therefore constructed to facilitate this process. This function is set-up to run multiple `sim_survey` calls in parallel using the **`doParallel`** package [@weston2015] and, as such, multiple loops can be run using the `n_loops` argument and, within each loop, multiple simulations can be run (controlled using the `n_sims` argument). Total simulations will be the product of `n_loops` and `n_sims` arguments. If more than one core (`cores`) is specified, then the simulations will be run in parallel to speed up the process. Low numbers of `n_sims` and high numbers of `n_loops` will be easier on RAM, but may be slower. The optimum ratio of `n_sims` to `n_loops` will depend on the amount of RAM and number of cores in a given computer. In any case, this function simplifies the process of running thousands of simulations of the same survey and the simulated data can then be supplied to survey-based or model-based analyses that require simulation testing. 

## Stratified analysis

Survey data need to be analyzed to obtain an index of abundance. While there are many model-based options for obtaining an index [e.g. @Thorson2015], design-based approaches, such as stratified analyses, are often used. Here we apply formula presented in Smith and Somerton [-@Smith1981; equations are replicated in [*Appendix C*][Appendix C: Stratified analysis equations]] to calculate stratified estimates of total abundance ($\hat{I}_{y,k}$), abundance at length ($\hat{I}_{l,y,k}$) and abundance at age ($\hat{I}_{a,y,k}$). Note that estimates of total abundance are based on aggregate catch while abundance at length requires length frequencies to be scaled up using set-specific ratios of measured to caught fish, and these length frequencies are converted to age by applying a division-level age-length-key. We used root-mean-squared error (RMSE) as a measure of the precision and bias of the abundance at age estimates from each survey:

$$RMSE = \sqrt{\frac{ \sum_{a = 1}^{N_a} \sum_{y = 1}^{N_y} \sum_{k = 1}^{N_k} (\hat{I}_{a,y,k} - I_{a,y})^2}{N_a N_y N_k}}$$

Where $N_a$, $N_y$, and $N_k$ are the number of ages, years and simulations, respectively, and $I_{a,y}$ is the true abundance available to the survey (i.e. catchability corrected abundance; $I_{a,y} = q_a N_{a,y}$). RMSE was also calculated for abundance at length estimates, where the above formula is indexed by length groups $l$, and total abundance, which lacks a group index of $a$ or $l$.

Stratified estimates of abundance are obtained by supplying the output from `sim_survey` to the `run_strat` function. RMSE of the stratified estimates can then be calculated using the `strat_error` function. Results and error of a stratified analysis of one survey over a population are obtained using the following code (using default values):

```{r, echo = TRUE, eval = FALSE}

set.seed(438)
sim <- sim_abundance() %>% 
  sim_distribution() %>% 
  sim_survey() %>% 
  run_strat() %>% 
  strat_error()

```

The returned object will include all the objects accumulated through the `sim_abundance` to `strat_error`. The `run_strat` function adds three data.tables called `total_strat`, `length_strat` and `age_strat` that include stratified estimates of total abundance, abundance at length, and abundance at age, respectively. To this, `strat_error` adds data.tables ending with `_strat_error` or `_strat_error_stats`. The `_strat_error` objects simply contain stratified estimates of abundance (column named `I_hat`) with corresponding true values of abundance available to the survey (column named `I`) and the `strat_error_stats` data.frame includes metrics of mean absolute error (`MAE`), mean-squared error (`MSE`) and root-mean-squared error (`RMSE`).

## Testing survey protocol

Assuming a stratified analysis as the default method for obtaining an index of abundance, a series of survey protocols can be tested using the `test_surveys` function. Provided a simulated population from `sim_distribution` and a series of survey protocols from `expand_surveys`, this function will simulate and analyze data from each survey using the `sim_survey`, `run_strat` and `strat_error` functions. Like `sim_survey_parallel`, this function operates in parallel and allows the specification of `n_sims` and `n_loops`, and the product of these two arguments equals the number of times each survey is simulated. Keep in mind that low numbers of `n_sims` and high numbers of `n_loops` will be less demanding on RAM, but may be slower, especially if the work is spread across few `cores`. Because most of the default settings of the functions match the case study settings, the code below will replicate the results from our case study (see [*Appendix A*][Appendix A: Case study] for more detail). The `expand_surveys` function sets up a series of `r nrow(expand_surveys())` surveys to test (i.e. all possible combinations of the `set_den`, `lengths_cap` and `ages_cap` vectors) and the `test_surveys` function will run 1000 simulations of each survey and compare stratified estimates of abundance to the true abundance available to the survey.

```{r, echo = TRUE, eval = FALSE}

set.seed(438)
pop <- sim_abundance() %>%
  sim_distribution()

surveys <- expand_surveys(set_den = c(0.0005, 0.001, 0.002, 0.005, 0.01),
                          lengths_cap = c(5, 10, 20, 50, 100, 500, 1000),
                          ages_cap = c(2, 5, 10, 20, 50))

tests <- test_surveys(pop, surveys = surveys,
                      n_sims = 5, n_loops = 200, cores = 3)

```

```{r data, eval = replot}

load("analysis/cod_sim_exports/2018-10-26_age_clust_test/test_output.RData")
tests <- sim

```

Processing time will be system (i.e. amount of RAM and number of cores) and setting (i.e. `n_loops` and `n_sims` ratio) dependent. The `test_survey` function will print a progress bar, generated using the **`progress`** package [@csardi2016], which details percent completion and will also include an estimate time of arrival (eta) after the first step of the loop completes. The `test_surveys` function therefore includes an option for exporting intermediate results to a local directory, via the `export_dir` argument, and the `resume_test` function can be used to resume a `test_surveys` run that had to be stopped part way through the process. The final object produced will be a list that includes all objects from `sim_abundance` and `sim_distribution` with the table of survey designs tested (named `surveys`) and tables produced by `strat_error` that end with the names `_strat_error` and `_strat_error_stats`. These tables include a `survey` column to allow merging of the survey protocol table with the error tables. Objects produced by `sim_survey` (set and sampling details) and `run_strat` (full stratified analysis results) are not retained to minimize object size. Like other core functions, some convenience functions are included in **`SimSurvey`** for creating interactive plots of the results from `test_surveys`. For instance a series of plotting functions ending in `_fan` produces fan charts where stratified estimates of abundance from each simulated survey are converted into a series of quantiles to depict the probability that estimates fall within a particular range. True values of abundance available to the survey are overlaid on the series of probability envelopes. These plots help visually assess the level of precision and bias from a specific set of survey protocol. The three lines of code below will produce interactive fan charts for stratified estimates of total abundance, abundance at length and abundance at age, respectively (e.g. Figure \@ref(fig:fan1), \@ref(fig:fan2), \@ref(fig:fan3)).

```{r, echo = TRUE, eval = FALSE}

plot_total_strat_fan(tests)
plot_length_strat_fan(tests, years = 1:20, lengths = 1:100)
plot_age_strat_fan(tests, years = 1:20, ages = 1:10)

```


```{r eval = replot}

surveys <- tests$surveys
set_dens <- c(0.0005, 0.002, 0.01)
i <- surveys$survey[surveys$set_den == set_dens[1] & surveys$lengths_cap == 10 & surveys$ages_cap == 10] # lengths_cap and ages_cap does not matter here
a <- plot_total_strat_fan(tests, surveys = i)
i <- surveys$survey[surveys$set_den == set_dens[2] & surveys$lengths_cap == 10 & surveys$ages_cap == 10]
b <- plot_total_strat_fan(tests, surveys = i)
i <- surveys$survey[surveys$set_den == set_dens[3] & surveys$lengths_cap == 10 & surveys$ages_cap == 10]
c <- plot_total_strat_fan(tests, surveys = i)

p <- subplot(a, b, c, nrows = 1, shareY = TRUE, titleX = FALSE) %>% 
  add_labels(x = 0.5, y = 0, text = "Year", yshift = -40) %>% 
  add_labels(x = c(0.1, 0.5, 0.9), y = rep(1, 3), yshift = 20, 
             text = paste("D<sub>sets</sub> =", set_dens))

export_plot(p, file = "analysis/paper/figures/plot_total_strat_fan.png", width = 700, height = 250)

```


```{r fan1, fig.cap = "Fan chart of stratified estimates of the trend in total abundance from surveys with different set densities, $D_{\\mathrm{sets}}$. The thick black line indicates the true trend in the total population available to the survey and the color gradient represents a range of probability envelopes from 10% to 90%. This plot is a facet of plots produced by `plot_total_strat_fan` when supplied results from `test_surveys`."}

knitr::include_graphics("figures/plot_total_strat_fan.png")

```


```{r eval = replot}

facet_fan <- function(data, ages = NULL, lengths = NULL, ylim = NULL, set_dens = c(0.0005, 0.002, 0.01), lengths_caps = c(10, 100, 1000)) {
  surveys <- data$surveys
  s <- expand.grid(set_den = set_dens, lengths_cap = lengths_caps)
  plot_list <- vector("list", nrow(s))
  for (i in seq_along(set_dens)) {
    for (j in seq_along(lengths_caps)) {
      s_i <- surveys$survey[surveys$set_den == set_dens[i] & surveys$lengths_cap == lengths_caps[j] & surveys$ages_cap == 10]
      if (is.null(ages)) {
        p <- plot_length_strat_fan(data, surveys = s_i, years = 7, lengths = lengths) %>% 
         layout(yaxis = list(range = ylim))
      } else {
        p <- plot_age_strat_fan(data, surveys = s_i, years = 7, ages = ages) %>% 
          layout(yaxis = list(range = ylim))
      }
      plot_list[[which(s$set_den == set_dens[i] & s$lengths_cap == lengths_caps[j])]] <- p
    }
  }
  subplot(plot_list, nrows = length(set_dens), shareX = TRUE, shareY = TRUE, titleX = FALSE, titleY = FALSE)
} 

p <- facet_fan(tests, lengths = 1:100, ylim = c(0, 21000000)) %>% 
  layout(margin = list(r = 30)) %>% 
  add_labels(x = c(0.1, 0.5, 0.9), y = rep(1, 3), yshift = 20, 
             text = paste("D<sub>sets</sub> =", c(0.0005, 0.002, 0.01))) %>% 
  add_labels(x = rep(1, 3), y = c(0.05, 0.5, 0.95), xshift = 30, textangle = 90,
             text = paste("M<sub>lengths</sub> =", rev(c(10, 100, 1000)))) %>% 
  add_labels(x = 0.5, y = 0, text = "Year", yshift = -40) %>% 
  add_labels(x = 0, y = 0.5, text = "Abundance index", xshift = -60, textangle = -90)

export_plot(p, file = "analysis/paper/figures/plot_length_strat_fan.png", width = 700, height = 600)

```


```{r fan2, fig.cap = "Fan chart of stratified estimates of abundance at length from year seven of the simulation from surveys with different set densities, $D_{\\mathrm{sets}}$, and length sampling protocol, $M_{\\mathrm{lengths}}$. The thick black line indicates the true trend in the total population available to the survey and the color gradient represents a range of probability envelopes from 10% to 90%. This plot is a facet of plots produced by `plot_total_strat_fan` when supplied results from `test_surveys`."}

knitr::include_graphics("figures/plot_length_strat_fan.png")

```

```{r, eval = replot}

p <- facet_fan(tests, ages = 1:10, ylim = c(0, 51000000)) %>% 
  layout(margin = list(r = 30)) %>% 
  add_labels(x = c(0.1, 0.5, 0.9), y = rep(1, 3), yshift = 20, 
             text = paste("D<sub>sets</sub> =", c(0.0005, 0.002, 0.01))) %>% 
  add_labels(x = rep(1, 3), y = c(0.05, 0.5, 0.95), xshift = 30, textangle = 90,
             text = paste("M<sub>age</sub> =", rev(c(10, 100, 1000)))) %>% 
  add_labels(x = 0.5, y = 0, text = "Year", yshift = -40) %>% 
  add_labels(x = 0, y = 0.5, text = "Abundance index", xshift = -60, textangle = -90)

export_plot(p, file = "analysis/paper/figures/plot_age_strat_fan.png", width = 700, height = 600)

```


```{r fan3, fig.cap = "Fan chart of stratified estimates of the trend in abundance at age four from surveys with different set densities, $D_{\\mathrm{sets}}$, and length sampling protocol, $M_{\\mathrm{lengths}}$. Number of ages sampled per length group, $M_{\\mathrm{ages}}$, was 10 in all scenarios. The thick black line indicates the true trend in the total population available to the survey and the color gradient represents a range of probability envelopes from 10% to 90%. This plot is a facet of plots produced by `plot_total_strat_fan` when supplied results from `test_surveys`."}

knitr::include_graphics("figures/plot_age_strat_fan.png")

```


The relative performance of the surveys tested can be compared using `plot_survey_rank` and `plot_error_surface`. The `plot_survey_rank` function produces a divergent dot plot of the results which ranks the surveys by RMSE. Using the `which_strat` argument, the plot can be focused on total, length or age based stratified results (Figure \@ref(fig:rank)). The `plot_error_surface` displays the age based stratified results by plotting a surface of RMSE (z-axis) by set (drop down selection), length (y-axis) and age (z-axis) sampling effort. The sampling effort axes can be rule or sample size based (`plot_by = "rule"` or `plot_by = "samples"`, respectively; Figure \@ref(fig:rmse-surface)).

```{r, echo = TRUE, eval = FALSE}

plot_survey_rank(tests, which_strat = "length")
plot_error_surface(tests, plot_by = "rule")

```


```{r, eval = replot}

sim <- tests
sim$surveys <- sim$surveys[sim$surveys$set_den %in% c("0.01", "0.002", "0.0005")]

p <- plot_survey_rank(sim, which_strat = "length")
export_plot(p, file = "analysis/paper/figures/plot_survey_rank.png", width = 450, height = 400)

totals <- sim$samp_totals[, list(n_sets = mean(n_sets), n_caught = mean(n_caught),
                                 n_measured = mean(n_measured), n_aged = mean(n_aged)),
                          by = "survey"]
errors <- merge(sim$surveys, sim$age_strat_error_stats, by = "survey")
d <- merge(errors, totals, by = "survey")

split_d <- split(d, d$set_den)
x <- sort(unique(d$ages_cap))
y <- sort(unique(d$lengths_cap))

scene <- list(
  xaxis = list(title = "Ages cap"),
  yaxis = list(title = "Lengths cap"),
  zaxis = list(title = "RMSE"),
  camera = list(eye = list(x = 1.5, y = 1.5, z = 1.5))
)

xshift <- c(-30, 0, 30)
p_list <- lapply(seq_along(split_d), function(i) {
  scene <- paste0("scene", i)
  z <- stats::xtabs(RMSE ~ ages_cap + lengths_cap, data = split_d[[i]], subset = NULL)
  plot_ly(x = x, y = y, scene = scene) %>% add_surface(z = t(z), showscale = FALSE) %>% 
    add_labels(x = 0.5, y = 1, text = paste("D<sub>sets</sub> =", names(split_d[i])), 
               yshift = -20, xshift = xshift[i])
})

p <- subplot(p_list) %>%  
  layout(scene = c(list(domain = list(x = c(0, 1/3), y = c(0, 1))), scene),
         scene2 = c(list(domain = list(x = c(1/3, 2/3), y = c(0, 1))), scene),
         scene3 = c(list(domain = list(x = c(2/3, 1), y = c(0, 1))), scene),
         autosize = FALSE, margin = list(t = 0, l = 10, r = 10, b = 10))
  
export_plot(p, file = "analysis/paper/figures/plot_error_surface.png", width = 990, height = 270)


```


```{r rank, fig.cap = "Divergent dot plot of the precision and accuracy (RMSE) of length based stratified estimates of abundance, and total sampling effort (number of sets [$N_{\\mathrm{sets}}$] and length measurements [$N_{\\mathrm{measured}}$]), under various sampling protocols (set density [$D_{\\mathrm{sets}}$] and maximum number of lengths measured per set [$M_{\\mathrm{lengths}}$]). Records are ranked by lowest to highest RMSE score. Within each plot, a color ramp is applied from lowest to highest value as an additional visual aid. Note that the exponent format of the axes defaults to SI unit symbols (e.g. M for million)."}

knitr::include_graphics("figures/plot_survey_rank.png")

```

```{r rmse-surface, fig.cap = "Surface plots of RMSE from an array of surveys with different sampling protocol. Panels represent surveys with different set densities ($D_{\\mathrm{sets}}$), x-axes represent the maximum sampling effort of lengths per set ($M_{\\mathrm{lengths}}$), and y-axes represent the maximum number of ages to collect per length group ($M_{\\mathrm{ages}}$). This plot is a facet of plots produced by `plot_error_surface` when supplied results from `test_surveys`. Note that RMSE scales are different across $D_{\\mathrm{sets}}$ facets. Note that the exponent format of the axes defaults to SI unit symbols (e.g. M for million)."}

knitr::include_graphics("figures/plot_error_surface.png")

```


## Assumptions

Like any model, this simulation is a simplification of a much more complex reality. For instance, the population is assumed to aggregate by age-class and be uniformly distributed within a cell, instead fish may aggregate by length and form finer-scale clusters. The survey is also an instantaneous snapshot of the population, meaning that the population is assumed to be in the same location from the beginning to the end of the survey. Also, fish are aged at random within length bins and ages are estimated without error. Finally, area trawled is assumed to be perfectly standard. These assumptions, plus a range of others, will surely under-represent the natural variability of fish populations and survey protocol. Nevertheless, the **`SimSurvey`** package provides the most realistic operating model that we are aware of for simulating stratified-random survey data from a population that varies across age, year and space dimensions.

<!-- # Should we include a summary of the case study - previous abstrat included below -->

<!-- A central question to fish stock assessments is: how many samples are needed to adequately represent the population being monitored? For assessments based on trawl surveys, our ability to estimate population characteristics, such as abundance at age, is affected by multiple levels of sampling (i.e. the number of sets, lengths and ages sampled in a survey). We therefore need to assess the impact of haul design and length and age sampling on survey accuracy to determine optimal sampling effort. In this study we simulated repeated stratified-random samples from a spatially correlated field of simulated fish. These samples were then analyzed and estimates of abundance at age were compared against a known truth. By varying the sampling protocol, we demonstrate that increasing the number of sets conducted per stratum provides the greatest gains in precision when sampling a clustered population. Increasing length and age sampling efforts also improved abundance estimates, but to a lesser extent and improvements were typically marginal, and sometimes squandered, when sub-sampling effort was increased. These results indicate that high levels of length and age sampling effort can be scaled back without significant losses to precision and, in some cases, estimates of abundance at age may be improved by reducing sub-sampling effort. Time saved by reducing said sampling may afford more time to conduct additional sets and/or increase sampling efforts of other species. While this simulation is tailored to a specific case, the method may be adapted to different systems and survey procedures. -->

# Research opportunities

The case study described in [*Appendix A*][Appendix A: Case study] provides one example of ways in which **`SimSurvey`** can be used to simulation test the design of fisheries-independent trawl surveys. There are multiple layers to the sampling design of such surveys and the end results are linked with the way such data are analyzed. Below we outline some examples where the **`SimSurvey`** package may aid future research efforts.

## Design or model-based approach

The analysis of data from fisheries-independent surveys have generally been confined to design-based mean and variance estimates of abundance using standard formula for stratified-random designs [e.g. @Cochran1977]. Nevertheless, there has long been interest in using model-based approaches to improve abundance estimates [e.g. @smith1990; @Berg2014; @Thorson2015]. **`SimSurvey`** can serve as a convenient tool for simulation testing mean and variance estimates provided by a range of different approaches (design-based analyses, bootstrap estimates, generalized additive models, geostatistical models, etc.). Moreover, the full analytical pathway for obtaining age-disaggregated estimates of abundance has rarely been simulation tested. Existing and future approaches for calculating age-based indices of abundance can be simulation tested using **`SimSurvey`**.

## Growth analyses

Assessing ages for a large number of fish is very time-consuming and, as such, length-stratified sampling is often used to estimate age frequencies of fish populations. The resultant sub-sample is used to construct an age-length key (i.e. the probability a fish is a specific age given length) and age frequencies are obtained by applying this key to length-frequencies obtained via more expansive random sampling. One age-length key is typically assumed to be representative of the whole stock area, however, spatial variability in the relationship may introduce bias in abundance-at-age estimates [@Berg2012]. Results from the case study (see [*Appendix A*][Appendix A: Case study]) reiterate this point and **`SimSurvey`** may serve as a platform for testing potential model-based solutions to this problem [e.g. @Berg2012].

## Random or stratified sampling

**`SimSurvey`** can be used to compare the precision and bias of population estimates obtained using random or stratified sampling. Simple random sampling can be implemented using a grid with one strata (e.g. `make_grid(depth_range = c(0, 1000), strat_breaks = c(0, 1000), strat_split = 0)`). Sub-sampling of ages can also be random rather than length-stratified by setting the `age_sampling` argument in the `sim_survey` function to `"random"` rather than `"stratified"`. This can facilitate research similar to work presented in Puerta et al. [-@puerta2019].

<!-- ESTIMATION OF VARIANCE. What does the stratified estimates of variance look like with the simulations you already have? Do negative values disapear above a praticular sampling intensity? -->


# Future directions

Up to now, the package has focused on the effects of sampling design on the precision and bias of population estimates obtained from fisheries-independent surveys; however, the costs associated with sampling has yet to be considered. In future iterations of **`SimSurvey`**, we hope to add options for integrating data on the time and monetary costs associated with each level of sampling (sets, length measurements, age determination) to facilitate cost-benefit analyses. We also realize that a single fisheries-independent survey may have multiple goals as data obtained are often used to assess multiple species or to conduct community analyses. We will therefore endeavor to add functions for simulating multi-species surveys. Finally, it would be useful to add an option for testing the consequences of surveys with partial coverage of a population as survey coverage is a frequent concern in stock assessment.


# Summary

The **`SimSurvey`** package serves as a tool for simulating stratified random surveys of dynamic populations that vary across ages, time and space. The core of the simulation is based on the widely used cohort equation and, even though the processes that define recruitment and total mortality are simple, a wide range of stock dynamics can be simulated by changing a few parameters. This base population can then be distributed through a grid and relationships with depth can be defined as can the nature of the correlation across ages, years and space. Together, two functions (`sim_abundance` and `sim_distribution`) are capable of simulating a wide range of populations with different life histories, depth associations and spatial properties. The next necessary steps to generating data similar to actual observations is to conduct a survey. In this package we implement a function, `sim_survey`, that conducts a stratified random survey of the population. The sampling process is governed by the area covered by the trawl as well as age-specific catchability. Sub-sampling protocol (length and age sampling) can also be varied. As such, data from a wide range of surveys can be simulated. 

A large number of statistical models that may be tested using these simulated data, but, implementing a variety of analytical approaches was outside the scope of this package. Instead we focus on analyzing simulated stratified-random survey data using a design-based stratified analysis. A stratified analysis is facilitated using the `run_strat` function and the precision and accuracy of the results (e.g. RMSE) can be calculated using `strat_error`. This is a simple and widely-used analysis, and the speed at which it runs allows for a wide range of survey designs to be tested, via the `test_surveys` function, in a reasonable time-frame.

Simulation testing is an important tool in the field of fisheries science as the inferred status of fish stocks hinge on the data and models used to assess fish populations. Simulations provide an opportunity to explore survey and model performance, and such explorations are becoming increasingly important as model complexity increases. It is also important to continually assess the efficacy and efficiency of sampling programs given their costs and the constant scrutiny of the value added by such surveys. These are some of the reasons multiple simulation frameworks, including **`SimSurvey`**, have been developed to test the design and analyses of complex surveys. We have made **`SimSurvey`** as open and accessible as possible to allow the broader community to validate, reuse and improve this package. We hope that open-source sharing will extend the value of such simulation frameworks and we encourage users to extend the package for their own needs and contribute to future versions.


# Acknowledgements

**Feedback and advice:** Aaron Adamack, Alejandro Buren, Noel Cadigan, Karen Dwyer, Geoff Evans, Brian Healey, Paul Higdon, Danny Ings, Mariano Koen-Alonso, Joanne Morgan, Derek Osborne, Pierre Pepin, Dwayne Pittman, Don Power, Craig Purchase, Martha Robertson, Mark Simpson, Brad Squires, Don Stansbury, Peter Upward

**Review of previous draft:** Dave Cote, Joanne Morgan

**Funding:** NSERC visiting-fellow program


# Appendix A: Case study

The construction of the **`SimSurvey`** package was motivated by a need to assess the sampling design of trawl surveys conducted along the Newfoundland and Labrador shelf by Fisheries and Oceans Canada. As a tangible first step, we focused our efforts on emulating data from the survey of cod in NAFO Subdivision 3Ps since it is one of the most dynamic and heavily sampled stocks in the region. Function settings were iteratively modified until it was difficult to distinguish the simulated data from real survey data; these values were set as the defaults for the main functions in the package. Here we evaluate the efficacy of alternate sampling protocols by assessing deviation of stratified estimates of abundance [@Smith1981] from the true abundance available to the survey. Although assessing model-based analyses was an option, we focused on the design-based stratified analysis for simplicity and because of its widespread use. The code below displays the core defaults will replicate the results of this case study. Results produced here are the same as those produced and displayed in a series of figures in the *[Testing survey protocol]* section of the paper.

```{r, echo = TRUE, eval = FALSE}

set.seed(438)

abundance <- sim_abundance(
  ages = 1:20,
  years = 1:20,
  R = sim_R(mean = 30000000,
            log_sd = 0.5),
  Z = sim_Z(mean = 0.5,
            log_sd = 0.2,
            phi_age = 0.9,
            phi_year = 0.5),
  growth = sim_vonB(Linf = 120, 
                    L0 = 5, 
                    K = 0.1,
                    log_sd = 0.1, 
                    length_group = 3)
)

distribution <- sim_distribution(
  abundance,
  grid = make_grid(x_range = c(-140, 140),
                   y_range = c(-140, 140),
                   res = c(3.5, 3.5),
                   shelf_depth = 200,
                   shelf_width = 100,
                   depth_range = c(0, 1000),
                   n_div = 1,
                   strat_breaks = seq(0, 1000, by = 40),
                   strat_splits = 2),
  ays_covar = sim_ays_covar(sd = 2.8,
                            range = 300,
                            phi_age = 0.5,
                            phi_year = 0.9,
                            group_ages = 5:20),
  depth_par = sim_parabola(mu = 200,
                           sigma = 70)
)

surveys <- test_surveys(
  distribution,
  surveys = expand_surveys(set_den = c(0.5, 1, 2, 5, 10) / 1000,
                           lengths_cap = c(5, 10, 20, 50, 100, 500, 1000),
                           ages_cap = c(2, 5, 10, 20, 50)),
  n_sims = 5, n_loops = 200, cores = 3,
  q = sim_logistic(k = 2, x0 = 3)
)


```


## Results

The default settings of `sim_abundance` and `sim_distribution` produces a dynamic population with a patchy and age-clustered distribution (Figure \@ref(fig:surface)a, \@ref(fig:distribution)a). In general, the function defaults dictate that all ages tend to aggregate in fairly dense clusters and that low-density zones are relatively wide-spread. Surveys, therefore, tend to be characterized by regions with large catches interspersed with regions of no catch (Figure \@ref(fig:survey)). The samples within each successful set are also variable and rarely include all length or age groups. This is because only moderate correlation ($\varphi_{\xi, \mathrm{age}}$ of 0.5) was imposed on the distributions of ages 1-5+, allowing individuals of different ages to occupy different locations, as is typically observed in the actual survey. These settings were chosen to simulated data that roughly correspond to actual survey data of cod from NAFO Subdivision 3Ps, where each age group between 1-4 tend to be caught at different locations while cod older than 4 years tend to be found at similar locations. In short, simulated data roughly emulate actual survey data with clustered catches and length samples with clear intra-haul correlation (Figure \@ref(fig:real-sim-comp)).

```{r real-sim-comp, fig.cap = "Comparison of a) real and b) simulated survey data where, from top to bottom, histograms of numbers caught across sets, distributions of set catches, and length-frequency distributions from three random sets are shown from a randomly selected year from the real and simulated 3Ps cod survey data. The colors of the length-frequency plots correspond to the colored locations. The deeper shades in the length-frequency plots represent numbers of fish sampled for age determination."}

knitr::include_graphics("figures/real_sim_comp.png")

```

Using the `test_surveys` function, a series of surveys were run over the simulated population and stratified analyses were run on the data obtained. The stratified analyses provided estimates of total abundance, abundance at length and abundance at age. Different stages of sampling affect these estimates, specifically, set density affects all estimates, length sampling affects estimates of abundance at length and abundance at age, and age sampling affects abundance at age estimates.  

The effect of set density on estimates of total abundance, abundance at length and abundance at age are clear across all figures generated from the `test_surveys` results (Figures \@ref(fig:fan1), \@ref(fig:fan2), \@ref(fig:fan3), \@ref(fig:rank), \@ref(fig:rmse-surface)). Across all fan plots, it is clear that the probability envelopes tighten (i.e. estimates are more precise) as set density is increased (Figures \@ref(fig:fan1), \@ref(fig:fan2), \@ref(fig:fan3)). Clear declines in RMSE are also apparent in estimates of abundance at length as set density is increased (Figure \@ref(fig:rank)) and there are notable differences in the scale of RMSE in estimates of abundance at age as set density is increased (Figure \@ref(fig:rmse-surface)). 

Compared to increases in set density, the effects of increased length sampling effort on abundance at length estimates are less clear. Regarding estimates of abundance at length, RMSE appears to reach a plateau at when length sampling effort is increased to 100 measurements per set (Figure \@ref(fig:rank)). Increasing the sampling rule above 100 measurements per set results in many more fish being measured, however, the increase in sampling effort is not matched with substantive declines in RMSE (Figure \@ref(fig:rank)). Further, it appears that measuring fewer total fish at more locations is more beneficial than measuring many fish at fewer locations (Figure \@ref(fig:rank)).

All levels of sampling affect the abundance at age estimates as set catches define the magnitude of the population, length sampling define the length distribution and data from the length-stratified age sampling is used to construct an age-length-key to convert length frequencies to age frequencies. Like the abundance at length estimates, the greatest improvements to RMSE come from increasing set density rather than sub-sampling effort (Figure \@ref(fig:rmse-surface)). Specifically, decreasing the age sampling protocol below 10 ages sampled per length group per division appears to result in relatively small increases to RMSE (Figure \@ref(fig:rmse-surface)). Length sampling effort, in contrast, has an uneven impact depending on the set density scenario. At low set densities ($D_{\mathrm{sets}}$ = 0.0005 sets / km^2^), RMSE declines when length sampling effort is increased from around 5 to around 100 measurements per set, and RMSE starts to increase as length sampling effort is increased beyond ~100 measurements per set; in fact, RMSE values appear higher at the highest length sampling scenario (1000 measurements / set) than the lowest (5 measurements / set; Figure \@ref(fig:rmse-surface)). A similar pattern is apparent under the medium set density scenario ($D_{\mathrm{sets}}$ = 0.002 sets / km^2^), however, RMSE values under the lowest and highest length sampling scenarios are of similar magnitude. Finally, RMSE continues to decline with increased length sampling effort under the high set density scenarios ($D_{\mathrm{sets}}$ = 0.01 sets / km^2^; Figure \@ref(fig:rmse-surface)).


## Discussion

The simple case study presented here revealed some expected, but also a few unexpected, patterns. First, and not surprisingly, there were clear improvements to precision in all population estimates as the number of sets were increased [@sutherland2006]. Second, stratified estimates of abundance at age were often biased and, in some cases, estimates were poorer when sub-sampling effort was increased. This result was unexpected because design-based estimators, such as the stratified analysis applied here, are expected to be unbiased [@smith1990] and large increases to sub-sampling effort could be expected to be relatively ineffective, but not detrimental. Results from stratified estimates of abundance at length, in contrast, better align with these expectations. By deduction, these results indicate that the issue stems from the intervening age-length key and not the design-based estimator.

Using an age-length key in conjunction with the length distribution to estimate abundance at age is standard procedure in the analysis of fisheries-independent survey data as only a small fraction of the catch are typically aged. The aging procedure is costly and time-consuming whereas length measurements are relatively easy to obtain. Ages are generally determined from length-stratified sub-samples of the catch and raw proportions of age-at-length are used to assign ages to fish in specific length groups. Age-length keys are usually constructed at larger spatial scales because there are rarely enough samples to construct a key at a finer spatial scale. Here we construct one age-length key for the division, as is done for the analysis of 3Ps cod. There is, however, a potential cost to the spatial scale of the key. Namely, it is unlikely that one age-length key is representative for the whole region because the probability of being a specific age given length varies in space [@Berg2012]. This would not be an issue if there was no size (age) specific clustering, however, this may not always be the case because different size groups often occur in different places because of ontogenetic habitat shifts [@dahlgren2000; @galaiduk2017]. For instance, it is not uncommon for populations to form distinct nursery and spawning areas [@marteinsdottir2000; @booth2000]. Because different age groups sometimes occur in different places, the translation of lengths to ages may be biased by the samples used to generate the age-length key. This bias is perhaps compounded by the length-stratified sampling of ages such that the ages sampled may be skewed towards sets with the most catch, especially under scenarios where length sampling effort is high. If this is the case, then the representativeness of the age-length key to the whole population could be diminished by excessive length sampling. 

The negative consequences of excessive length sampling on abundance at age estimates are most apparent under the low set density scenarios. The precision of the estimates are also the poorest when fewer sets are conducted. Sets, however, are the most costly sample to obtain and, as such, the set densities of fisheries-independent surveys tend to be on the lower end of the scenarios presented in this paper. The set density of the multi-species survey conducted by Fisheries and Oceans Canada in the Newfoundland region, for instance, ranges between 0.001 and 0.002 sets / km^2^. Length sampling effort, in contrast, tends to be on the higher end of the scenarios presented here because lengths are relatively easy to obtain. Again, using Fisheries and Oceans Canada sampling protocol from the Newfoundland region as an example, it is not uncommon for length sampling effort to be capped at 500 measurements per set. The results presented in this paper paradoxically suggest that better abundance at age estimates are obtained by lowering the length sampling cap. Results also indicate that reductions to length sampling effort would not significantly impact abundance at length estimates. Nonetheless, it is hard to be prescriptive because this simulation is far from a perfect reflection of reality and it focuses on one case study. Further research is required on the consequences of some of the assumptions of this simulation as well as the interaction between age-specific clustering, length-stratified sampling and the age-length key. Ideally, the simulation would also include multiple species with different life-histories and distributions, and also integrate a cost component to assess the trade-offs between information and cost. Finally, it would be interesting to test alternate analyses of these data that may account for the spatial structure of the age-length key [e.g. @Berg2012].

While much work has yet to be done, results from the simple simulation echo the growing body of literature which concludes that extra sub-sampling is an ineffective means of improving estimates relative to sampling more locations [@Pennington1994; @Pennington2002; @Stewart2014; @Bogstad1995; @Coggins2013; @Zhang2013]. In general, the most significant source of variation in fisheries-independent surveys stems from set-to-set variation, and not variability from individual sub-samples. This is largely because fish caught together tend to be more similar than those in the general population [@Pennington1994]. Therefore, if the goal of a trawl survey is to maximize information, it is likely better to stop collecting correlated samples and, instead, focus efforts the next set and/or other species. This is simply one example of the questions that can be explored using **`SimSurvey`**.


# Appendix B: Age-year-space covariance

The simulation applied in this paper was set-up to control covariance across ages, years and space. To do this we used a combination of Matérn covariance, to control the level of spatial aggregation, and the age-year covariance described in Cadigan [-@Cadigan2016], to control the level of similarity in distributions across ages and years. As described in Appendix A in Cadigan [-@Cadigan2016], the age-year covariance can be broken down into a series of AR(1) processes. We integrate Matérn covariance into this series of equations:

$$\xi_{a,y,s} \sim \left\{\begin{matrix} MVN\left (0, \frac{\sigma_\xi^2}{(1 - \varphi_{\mathrm{age}}^2)(1 - \varphi_{\mathrm{year}}^2)} \boldsymbol{R}_s \right ) & a = 1, y = 1 & \\  MVN\left (\varphi_{\mathrm{year}} \xi_{1, y - 1, s}, \frac{\sigma_\xi^2}{(1 - \varphi_{\mathrm{age}}^2)} \boldsymbol{R}_s \right ) & a = 1, y > 1 & \\ MVN\left (\varphi_{\mathrm{age}} \xi_{a - 1, 1, s}, \frac{\sigma_\xi^2}{(1 - \varphi_{\mathrm{year}}^2)} \boldsymbol{R}_s \right ) & a > 1, y = 1 & \\ MVN\left (\varphi_{\mathrm{year}} \xi_{a, y - 1, s} + \varphi_{\mathrm{age}} (\xi_{a - 1, y, s} - \varphi_{\mathrm{year}} \xi_{a - 1, y - 1, s}), \sigma_\xi^2 \boldsymbol{R}_s \right ) & a > 1, y > 1 & \end{matrix}\right.$$

Where $MVN$ indicates the multivariate normal distribution, $\sigma_\xi^2$ controls the variance of the process, $\varphi_{\xi, \mathrm{age}}$ and $\varphi_{\xi, \mathrm{year}}$ control correlation in the age and year dimension and $\boldsymbol{R}_s$ is defined by Matérn correlation:

$$\boldsymbol{R}_s = \frac{2^{1-\lambda}}{\Gamma(\lambda)} (\kappa \left |s_i - s_j \right|) K_{\lambda}(\kappa \left |s_i - s_j \right|)$$
where $\left |s_i - s_j \right|$ is the Euclidean distance between two locations, $\Gamma$ is the gamma function, $K_{\lambda}$ denotes the modified Bessel function of the second kind, and $\lambda$ and $\kappa$ control the smoothness and scale of the spatial process [@Blangiardo2015]. With this structure, simulated error is correlated across ages, years and space.

<br>

# Appendix C: Stratified analysis equations

Standard notation for use in the analysis of stratified-random survey data [modified from @Smith1981]:
                                                     
| **Equation** | **Description** |
|:---------- |:----- |
| $L$ | Number of strata ($h = 1, 2, ....., L$) |
| $A_h$ | Area of the $h^{th}$ stratum |
| $A_{\mathrm{trawl}}$ | Area covered by a standard trawl |
| $N_h = \frac{A_h}{A_{\mathrm{trawl}}}$ | Total number of sample units in the $h^{th}$ stratum |
| $n_h$ | Total number of units sampled in the $h^{th}$ stratum ($i = 1, 2, ....., n_h$) |
| $N = \sum^{L}_{h = 1} N_h$ | Total number of sample units in the survey |
| $n = \sum^{L}_{h = 1} n_h$ | Total number of observations in the survey |
| $W_h = \frac{N_h}{N}$ | Stratum weight |
| $f_h = \frac{n_h}{N_h}$ | Sampling fraction in the $h^{th}$ stratum |
| $\overline{I}_h = \sum^{n_h}_{i = 1} \frac{I_{h, i}}{n_h}$ | Sample mean in the $h^{th}$ stratum, where $I_{h, i}$ is the $i^{th}$ observation in the $h^{th}$ stratum |
| $s^2_h = \sum^{n_h}_{i = 1} \frac{(I_{h, i} - \overline{I}_h)}{(n_h - 1)}$ | Sample variance in the $h^{th}$ stratum |
| $\overline{I} = \sum^{L}_{h = 1} W_h \overline{I}_h$ | Estimate of the population mean per unit (i.e. stratified mean catch per tow) |
| $s^2(\overline{I}) = \frac{1}{N^2} \sum^{L}_{h=1} N_h (N_h - n_h) \frac{s^2_h}{n_h}$ | Estimate of the variance of the stratified mean |
| $\widehat{I} = N \overline{I}$ | Estimate of the population total over the survey area |



# References



<!-- # Quotes -->

<!-- "To effectively manage rare populations, accurate monitoring data are critical. Yet many monitoring programs are initiated without careful consideration of whether chosen sampling designs will provide accurate estimates of population parameters. Obtaining accurate estimates is especially difficult when natural variability is high, or limited budgets determine that only a small fraction of the population can be sampled." - Morrison et al. (2008) Popul Ecol 50:417–425 -->

<!-- "Fishery independent surveys provide valuable information on fish population characteristics and play important roles in fisheries stock assessment (Gunderson, 1993; Rago, 2005). The importance of fishery independent surveys has been well recognized, but the important role of sampling design for these surveys is less appreciated. Often, traditional survey methods are used without considering survey designs that maximize the precision and accuracy of the estimator (Mier and Picquelle, 2008). Fishery independent surveys are usually expensive and time-consuming, and an efficient sampling design is key to the success of these surveys. Recently, investigators have begun to pay more attention to the importance of survey sampling and are exploring a variety of aspects of designs (Bez, 2002; Brown, 2003; Kimura and Somerton, 2006). Based on the previous studies, we compared the performance of traditional and adaptive sampling designs with emphasis on simulation application for performance comparison." - Yu et al. (2012) Fisheries Research 113: 173–181 -->

<!-- # Examples -->

<!-- Good examples of papers on packages: -->
<!-- - https://journals.plos.org/plosone/article?id=10.1371/journal.pone.0092725#s4 -->
<!-- - file:///C:/Users/RegularP/Downloads/Mildenberger_et_al-2017-Methods_in_Ecology_and_Evolution.pdf -->

<!-- # READ -->

<!-- - https://onlinelibrary.wiley.com/doi/pdf/10.1046/j.1467-2960.2001.00047.x -->



