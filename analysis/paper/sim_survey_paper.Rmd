---
title: Using simulation to optimize the sampling design of fisheries-independent trawl surveys
author: "Paul M. Regular, Fran Mowbray, et al.?"
date: "Fisheries and Oceans Canada, Northwest Atlantic Fisheries Center, 80 East White Hills, St. John's, Newfoundland and Labrador, A1C 5X1, Canada"
output: 
  bookdown::word_document2:
    reference_docx: template.docx
bibliography: references.bib
csl: ices-journal-of-marine-science.csl
---

```{r setup, include=FALSE}

# devtools::install_github("rstudio/rmarkdown@v1.10")
knitr::opts_chunk$set(echo = FALSE,
                      message = FALSE,
                      warning = FALSE,
                      dev = "png",
                      dpi = 300)
knitr::opts_knit$set(root.dir = "../..")
options(scipen = 999) # turn off scientific notation to simplify printing

```


```{r packages, include = FALSE}

library(SimSurvey)
library(plotly)
library(raster)
library(lattice)
library(viridis)
library(data.table)
Sys.setenv("MAPBOX_TOKEN" = "pk.eyJ1IjoicGF1bHJlZ3VsYXIiLCJhIjoiY2pueGIxejMxMGM0MjNqbjR1aXdwYm92bSJ9.R-t1SCa0VHKf4N-PQmYI5Q")
source("analysis/paper/helper_functions.R")

replot <- FALSE # plot the figures again? (acts as a manual cache)

```


# Abstract

A central question to fish stock assessments is: how many samples are needed to adequately represent the population being monitored? For assessments based on trawl surveys, our ability to estimate population characteristics, such as abundance at age, is affected by multiple levels of sampling (i.e. the number of sets, lengths and ages sampled in a survey). We therefore need to assess the impact of haul design and length and age sampling on survey accuracy to determine optimal sampling effort. In this study we simulated repeated stratified-random samples from a spatially correlated field of simulated fish. These samples were then analyzed and estimates of abundance at age were compared against a known truth. By varying the sampling protocol, we demonstrate that increasing the number of sets conducted per stratum provides the greatest gains in precision when sampling a clustered population. Increasing length and age sampling efforts also improved abundance estimates, but to a lesser extent and improvements were typically marginal, and sometimes squandered, when sub-sampling effort was increased. These results indicate that high levels of length and age sampling effort can be scaled back without significant losses to precision and, in some cases, estimates of abundance at age may be improved by reducing sub-sampling effort. Time saved by reducing said sampling may afford more time to conduct additional sets and/or increase sampling efforts of other species. While this simulation is tailored to a specific case, the method may be adapted to different systems and survey procedures.

**Keywords** - length and age distribution; simulation; spatial correlation; stratified analysis; survey design

# Introduction

Fisheries-independent trawl surveys have become an increasingly important research tool for the management of dynamic fish stocks. These surveys provide reliable indices of population abundance as well as estimates of various population characteristics such as length and age frequencies [@Pennington1998]. While costly to obtain, this information forms the basis of of many stock assessments models used throughout the world. Effective and informed management decisions therefore require surveys that maximize information while minimizing the expense of data collection. Determining the number of samples required to adequately characterize a fish population is particularly challenging since data tend to be collected across one or more stages [@Aanes2015]. Optimal survey design is further complicated by the fact that trawls sample clusters of fish that tend to have similar characteristics, such as length, age and stomach contents. This phenomenon results in samples with positive intra-haul correlation, which can markedly reduce the effective sample size for estimating length and age frequencies of the target population [@Pennington1994; @Pennington2002; @Stewart2014]. The complexities of multi-stage sampling and intra-haul correlation make it difficult to answer the question *"how much sampling is enough?"*  

Two main approaches have been applied to try and answer this question: one involves statistical estimators of effective sample size [@Pennington2002; @Stewart2014], and the other employs resampling methods to test alternate sampling protocol [@Cervino2006; @Zhang2013]. Both approaches have shown that lengths are usually oversampled and a reduction in said sampling can often be done without significant loss of accuracy [@Pennington2002]. The same result holds for other positively correlated characteristics, such as age [@Coggins2013] and stomach contents [@Bogstad1995]. Pennington and VÃ¸lstad [-@Pennington1994] concluded that the best way to improve the accuracy of surveys with strong intra-haul correlation is to take fewer samples per sampling unit and increase the total number of sampling locations. Few studies, however, have tested these conclusions using simulations. Simulations are a useful approach for informing the design of surveys [@sutherland2006] and they have been used widely for exploring the number of samples needed to obtain estimates with reasonable precision [e.g. distance sampling surveys; @thomas2010]. A key advantage of a pure simulation approach is that "true" population size and all stages of sampling can be controlled (set, length and age sampling protocol). The relative effects of each stage of sampling on our perception of the "truth" can then be tested. This level of testing is of particular importance for age composition estimates, and the contemporary age-based assessment models that rely on these estimates, as they are affected by all stages of sampling. A key challenge, of course, is building a simulation that emulates reality.  

The objective of this paper is to use a realistic simulation to evaluate the efficacy of various sampling protocol. First we simulated a spatially autocorrelated target population, and then we simulated surveys over this field. Set density was varied across surveys, as was length and age sampling efforts. Estimates of abundance at age were then obtained using a standard stratified approach [@Smith1981] and deviation from the truth was assessed. Given previous findings, we predict that the greatest gains in precision will come from increasing the number of hauls; increased sampling of correlated variables (length and age) on a set by set basis will be relatively ineffective. The bottom trawl survey of cod (*Gadus morhua*) in NAFO division 3Ps, Newfoundland, was used as a case study for this analysis. While our case study is specific, we also hope that the approach presented here will provide a framework for optimizing sampling protocol for an array of species with different life-histories and distributions. To facilitate future work and collaborations, we have developed an R package for conducting the tests presented in this paper (https://github.com/PaulRegular/SimSurvey).


# Methods

The SimSurvey package was written in the programming language R [@R] and, in short, the package allows for the simulation of stratified-random surveys of an age-structured population that varies in space and time. SimSurvey relies heavily on functions from the data.table [@dowle2017], raster [@hijmans2016] and plotly [@sievert2018] packages for their efficient data processing, geographic and plotting facilities, respectively. All the source R code behind SimSurvey is available on GitHub (https://github.com/PaulRegular/SimSurvey) and the 0.1.0 release of the package can be installed via GitHub:

```{r, echo = TRUE, eval = FALSE}
install.packages("devtools")
devtools::install_github("PaulRegular/SimSurvey@v0.1.0") 
```


## Case study

The construction of the SimSurvey package was motivated by a regional need for assessing the sampling design of trawl surveys conducted along the Newfoundland and Labrador shelf by Fisheries and Oceans Canada. As a tangible first step, we focused our efforts on emulating data from the survey of cod in NAFO division 3Ps since it is one of the most dynamic and heavily sampled stocks in the region. Below we outline the equations behind a series of SimSurvey functions that were used to simulate survey data with similar features to data obtained by the survey of 3Ps cod. The settings were iteratively modified until it was difficult to distinguish the simulated data from real survey data; these values were set as the defaults for the main functions in the package. Here we evaluate the efficacy of alternate sampling protocol by assessing deviation between stratified estimates of abundance [@Smith1981] from the true abundance available to the survey. While assessing model-based analyses was an option, we focused on the design-based stratified analysis for simplicity and because of its widespread use. See Table \@ref(tab:par) for a description of the code used to generate the case study results.


Table: (\#tab:par) - Main function calls, with argument descriptions and associated parameter symbols, used to simulate the cod-like population used in the case study presented here. Note that the settings below largely correspond with the defaults used in the functions.

|                                       **Function call** |                                            **Description** |                 **Symbol** |
|:------------------------------------------------------- |:---------------------------------------------------------- | :------------------------- |
| `> set.seed(438)`                                       |      Set random number generator seed to replicate results |                            |
| `>`                                                     |                                                            |                            |
| `> abundance <- sim_abundance(`                         |                                       *Simulate abundance* |                            |         
| `+   ages = 1:20,`                                      |                                                       Ages |                        $a$ |
| `+   years = 1:20,`                                     |                                                      Years |                        $y$ |
| `+   R = sim_R(mean = 30000000,`                        |                                           Mean recruitment |                    $\mu_r$ |
| `+             log_sd = 0.5),`                          |                      Standard deviation of log-recruitment |                 $\sigma_r$ |
| `+   Z = sim_Z(mean = 0.5,`                             |                                       Mean total mortality |                    $\mu_Z$ |
| `+             log_sd = 0.2,`                           |                      Standard deviation of total mortality |                 $\sigma_Z$ |
| `+             phi_age = 0.9,`                          |    Correlation across ages in error around total mortality |    $\varphi_{\delta, age}$ |
| `+             phi_year = 0.5),`                        |   Correlation across years in error around total mortality |   $\varphi_{\delta, year}$ |
| `+   growth = sim_vonB(Linf = 120,`                     |                                Mean asymptotic length (cm) |               $l_{\infty}$ |
| `+                     L0 = 5,`                         |                                       Length at birth (cm) |                      $l_0$ |
| `+                     K = 0.1,`                        |                                                Growth rate |                        $K$ |
| `+                     log_sd = 0.1,`                   |     Standard deviation of the von Bertalanffy growth curve |                 $\sigma_l$ |
| `+                     length_group = 3))`              |                  Length group for abundance at length (cm) |            $l_{group}^{N}$ |      
| `>`                                                     |                                                            |                            |
| `> grid <- make_grid(`                                  |                                              *Make a grid* |                            |
| `+   x_range = c(-140, 140),`                           |                           Range of grid in the x dimension |                            |                   
| `+   y_range = c(-140, 140),`                           |                           Range of grid in the y dimension |                            | 
| `+   res = c(3.5, 3.5),`                                |                                       Grid resolution (km) |                        $R$ |
| `+   shelf_depth = 200,`                                |                                           Shelf depth (km) |                $d_{shelf}$ |
| `+   shelf_width = 100,`                                |                                           Shelf width (km) |                $w_{shelf}$ |
| `+   depth_range = c(0, 1000),`                         |                                            Depth range (m) |       $[d_{min}, d_{max}]$ |
| `+   n_div = 1,`                                        |                                        Number of divisions |                  $N_{div}$ |
| `+   strat_breaks = seq(0, 1000, by = 40))`             |                 Series of depth breaks for defining strata |                            |
| `>`                                                     |                                                            |                            |
| `> distribution <- sim_distribution(`                   |                                    *Simulate distribution* |                            |     
| `+   sim = abundance,`                                  |                Object produced by `sim_abundance` function |                            |     
| `+   grid = grid,`                                      |                    Object produced by `make_grid` function |                            |
| `+   ays_covar = sim_ays_covar(sd = 2.8,`               |          Standard deviation of age-year-space distribution |             $\sigma_{\xi}$ |
| `+                             range = 300,`            |                          Range of spatial correlation (km) |                        $r$ |
| `+                             phi_age = 0.5,`          |            Correlation across ages in spatial distribution |       $\varphi_{\xi, age}$ |
| `+                             phi_year = 0.9,`         |           Correlation across years in spatial distribution |      $\varphi_{\xi, year}$ |
| `+                             group_ages = 5:20),`     |       Make space-age-year variance equal across these ages |                            |
| `+   depth_par = sim_parabola(mu = 200,`                |          Depth at which abundance is typically highest (m) |                    $\mu_d$ |
| `+                            sigma = 70))`             |              Dispersion around depth of peak abundance (m) |                 $\sigma_d$ |
| `>`                                                     |                                                            |                            |
| `> surveys <- expand_surveys(`                          |                       *Define a series of surveys to test* |                            |
| `+   set_den = c(0.0005, 0.001, 0.002, 0.005, 0.01),`   |                                       Set density (km^-2^) |                 $D_{sets}$ |
| `+   lengths_cap = c(5, 10, 20, 50, 100, 500, 1000),`   |                 Maximum number of lengths to collect / set |              $M_{lengths}$ |
| `+   ages_cap = c(2, 5, 10, 20, 50))`                   | Maximum number of ages to sample / length group / division |                 $M_{ages}$ |
| `>`                                                     |                                                            |                            |
| `> tests <- test_surveys(`                              |                             *Simulate and analyze surveys* |                            |
| `+   sim = distribution,`                               |             Object produced by `sim_distribution` function |                            |
| `+   surveys = surveys,`                                |               Object produced by `expand_surveys` function |                            |
| `+   n_loops = 1000,`                                   |                    Number of times to simulate each survey |                            | 
| `+   q = sim_logistic(k = 2,`                           |                Steepness of logistic curve of catchability |                        $k$ |
| `+                   x0 = 3),`                          |                 Midpoint of logistic curve of catchability |                      $x_0$ |
| `+   trawl_dim = c(1.5, 0.02),`                         |       Trawl dimensions (km) - i.e. area covered by a trawl |                $A_{trawl}$ |
| `+   length_group = 1)`                                 |                         Length group for age sampling (cm) |                $l_{group}$ |

*Caution:* as written, the `test_surveys` function call may take days or weeks to run. Run duration can be decreased by running multiple simulations per loop (`n_sims` argument) and by running the loops in parallel (`cores` argument). See help file for more details (`?test_surveys`).

<br>


## Simulate abundance

The simulation starts with a common cohort model where the abundance at age $a$ in year $y$ ($N_{a,y}$) equals the abundance of that cohort in the previous year multiplied by the survival rate, which is expressed in terms of total mortality ($Z_{a,y}$):

$$N_{a,y} = N_{a-1,y-1} e^{-Z_{a-1,y-1}}$$
Here, numbers at age in the first year are filled via exponential decay, $N_{a,1} = N_{a-1,1} e^{-Z_{a-1,1}}$, numbers at age 1 (i.e. recruits) vary around a baseline value, $log(N_{1,y}) = log(\mu_r) + \epsilon_{y}$, and total mortality is set to a baseline level plus process error, $log(Z_{a,y}) = log(\mu_Z) + \delta_{a,y}$. The error around the recruitment process was set to follow a random walk, $\epsilon_{y} \sim N(\epsilon_{y - 1}, \sigma_{r}^{2})$, and the process error was simulated using the covariance structure described in Cadigan [-@Cadigan2016], $\delta_{a,y} \sim N(0, \Sigma_{a,y})$. The covariance across ages and years is controlled by a process error variance parameter ($\sigma_{\delta}^2$) along with age and year correlation parameters ($\varphi_{\delta, age}$ and $\varphi_{\delta, year}$, respectively). This structure allows for autocorrelation in process errors across ages and years (i.e. total mortality can be made to be more similar for fish that are closer together in age and time). Abundance at age is then converted to abundance at length using the original von Bertalanffy growth curve [@Cailliet2006]:

$$log(l) = log(l_{\infty} - (l_{\infty} - l_0) e^{-Ka}) + \varepsilon$$

Where $l_{\infty}$ is the mean asymptotic length, $l_0$ is length at birth, $K$ is the growth rate parameter and the error is assumed to follow the normal distribution, $\varepsilon \sim N(0, \sigma_{l}^2)$. Abundance in discrete length groups, $l_{group}^{N}$, was determined by using this formula to calculate the probability of being within a specific length group given age and then using the resultant length-age-key to convert abundance at age to abundance at length. Overall, this  formulation allows for the simulation of an array of population dynamics that one might expect to observe. 

Abundance is simulated using the `sim_abundance` function and the settings used for our case study are shown in Table \@ref(tab:par). These settings are also the defaults of the function. This function has a simple structure and requires the specification of a series of `ages` and `years` along with functions for simulating recruitment (`R`), total mortality (`Z`) and growth (`growth`). The package includes the functions `sim_R`, `sim_Z` and `sim_vonB` for simulating recruitment, total mortality and growth, respectively. These functions are "closures" [i.e. functions that contain data and return functions; @wickham2014] and this structure was chosen to avoid the repeated specifications of ages and years. The use of closures also allows users to use their own closures with a similar structure but different underlying formula. Overall, the function provides a simple tool for simulating a range dynamic age-structured populations. For instance, below we simulate a relatively long (default case study settings) and short lived species.

```{r, echo = TRUE, eval = replot}
set.seed(438)
a <- sim_abundance(ages = 1:20,
                   R = sim_R(mean = 3e+07),
                   Z = sim_Z(mean = 0.5))
b <- sim_abundance(ages = 1:6,
                   R = sim_R(mean = 1e+10),
                   Z = sim_Z(mean = 0.8))
```

The `sim_abundance` function returns a list with the sequence of ages (`ages`), sequence of years (`years`), sequence of lengths (`lengths`), numbers of recruits across all years (`R`), numbers at age in the first year (`N0`), total mortality matrix (`Z`), abundance at age matrix (`N`), abundance at length matrix (`N_at_length`) and the function supplied to the `growth` argument (`sim_length`). The growth function is retained for later use in `sim_survey` to simulate lengths given simulated catch at age in a simulated survey.

The package also includes several plotting function for making quick plotly-based [@sievert2018] interactive visuals of the simulated population. For instance, the `plot_surface` function can be used to make quick visuals of matrices contained within the list returned by `sim_abundance`. The plots output from the below code are combined into Figure \@ref(fig:surface). Here we display the abundance at age matrix (object named `N` in the list produced by `sim_abundance`); other names can be supplied to the `mat` argument to visualize a different matrix from the `sim_abundance` list, such as `Z`.

```{r, echo = TRUE, eval = FALSE}
plot_surface(a, mat = "N")
plot_surface(b, mat = "N")
```


```{r, eval = replot}
set.seed(438)
a <- sim_abundance(ages = 1:20,
                   R = sim_R(mean = 3e+07),
                   Z = sim_Z(mean = 0.5))
b <- sim_abundance(ages = 1:6,
                   R = sim_R(mean = 1e+10),
                   Z = sim_Z(mean = 0.8))

pa <- plot_surface(a, mat = "N", scene = "scene1", showscale = FALSE) %>% 
  add_labels(x = 0.05, y = 0.9, text = "a)")
pb <- plot_surface(b, mat = "N", scene = "scene2", showscale = FALSE) %>% 
  add_labels(x = 0.05, y = 0.9, text = "b)")

p <- subplot(pa, pb) %>%
  layout(scene = list(domain = list(x = c(0, 0.5), y = c(0, 1))),
         scene2 = list(domain = list(x = c(0.5, 1), y = c(0, 1)),
                       xaxis = list(title = "Age"),
                       yaxis = list(title = "Year"),
                       zaxis = list(title = "N")))

export_plot(p, file = "analysis/paper/figures/plot_surface.png", width = 800, height = 370)
```


```{r surface, fig.cap = "- Surface plots of simulated abundance at age of a relatively a) long lived (case study settings) and b) short lived species. These plots were produced by `plot_surface` when supplied a list produced by `sim_abundance`."}

knitr::include_graphics("figures/plot_surface.png")

```



## Simulate spatial distribution

The next step in the simulation is to distribute the abundance at age matrix simulated using the cohort model throughout a spatial field. Here, a grid of $s$ locations was generated with a resolution of $R$ and a depth gradient. The depth gradient was set-up to have a sigmoid shape with a depth range of $[d_{min}, d_{max}]$, shelf depth of $d_{shelf}$ and a shelf width of $w_{shelf}$. The grid is divided into $N_{div}$ divisions and $N_{strat}$ depth-based strata. The simulated population is distributed through the grid by simulating spatial-temporal noise controlled by a parabolic relationship with depth and covariance between ages, years and space

$$\begin{aligned}log(N_{a,y,s}) &= log(N_{a,y}) + \eta_{a,y,s} \\ \eta_{a,y,s} &= \frac{(d_s - \mu_{d}) ^ 2}{2 \sigma_d^2} + \xi_{a,y,s} \end{aligned}$$

Where $d_s$ is the depth in a specific cell of the grid, $\mu_d$ is the mean depth where abundance is typically highest and $\sigma_d$ controls the width or dispersion of abundance around the mean. This helps simulate depth preferences of particular fish. Residual noise $\xi_{a,y,s}$ is added to this depth relationship using a combination of MatÃ©rn covariance, to control the level of spatial aggregation, and the age-year covariance described in Cadigan [-@Cadigan2016], to control the level of similarity in distributions across ages and years. Spatial correlations was controlled by a smoothing ($\lambda$) and scaling parameter ($\kappa$) [here we approximate $\kappa$ from a range parameter ($r$), $\kappa = \sqrt{8 \lambda} / r$; @Blangiardo2015] and correlation across ages and years was controlled by $\varphi_{\xi, age}$ and $\varphi_{\xi, year}$, respectively. The overall variance of the process was controlled by $\sigma_{\xi}^2$. In short, this formulation allows control of depth preferences, the level of spatial aggregation and the amount of age and year specific clustering. Note that $\eta_{a,y,s}$ is forced to sum to one in each year to ensure that the total population of each age for each year through the grid equals the number simulated by the cohort model. Also note that numbers were rounded such that a discrete number of fish are in each cell of the grid. A more detailed description of the space-age-year covariance is included in Appendix 1. Note that the the distributions of specific length groups were not simulated because of the greater computational cost of storing spatially dis-aggregated abundance across all length groups. 

The `make_grid` function is used to generate a survey grid for use in the `sim_distribution` function. The output from `make_grid` is a raster object [@hijmans2016] with four layers: `depth`, `cell`, `division` and `strat`. If a more detailed and realistic grid is required, users can manually generate their own survey grid using real data and this grid can be supplied to `sim_distribution` if the same structure is used. The package includes a manually constructed survey grid of NAFO division 3Ps (named `survey_grid`) and the data-raw folder in the GitHub directory includes the data and code used to construct this grid. However, for simplicity, we use `make_grid` to construct a square grid for our case study and the settings used are shown in Table \@ref(tab:par). Below we generate and plot (combined in Figure \@ref(fig:grid)) a default case study grid and another grid with four divisions and a more linear gradient in depth.

```{r, echo = TRUE, eval = FALSE}

a <- make_grid(n_div = 1, shelf_depth = 200,
               shelf_width = 100, depth_range = c(0, 1000))
b <- make_grid(n_div = 4, shelf_depth = 500, 
               shelf_width = 0, depth_range = c(0, 1000))
plot_grid(a)
plot_grid(b)

```


```{r eval = replot}

a <- make_grid() %>% 
  plot_grid(showscale = TRUE) %>% 
  add_labels(x = 0, y = 1, text = "a)")
b <- make_grid(n_div = 4, shelf_depth = 500, shelf_width = 0, depth_range = c(0, 1000)) %>% 
  plot_grid(showscale = FALSE) %>% 
  add_labels(x = 0.01, y = 1, text = "b)")
p <- subplot(a, b)

export_plot(p, file = "analysis/paper/figures/plot_grid.png", width = 800, height = 430)

```


```{r grid, fig.cap = "- Plots produced by `plot_grid` when supplied an raster object produced by `make_grid` a) using default case study settings and b) settings generates a grid with four divisions and a more linear depth gradient. In these plots, the color gradient represents depth, the grey lines deliniate divisions and white lines deliniate strata."}

knitr::include_graphics("figures/plot_grid.png")

```

The `sim_distribution` function distributes the population simulated using `sim_abundance` throughout the grid generated using `make_grid`. Table \@ref(tab:par) outlines the default settings used for the function and the case study. In addition to supplying objects produced by `sim_abundance` and `make_grid`, this function requires two closures that describe the age-year-space covariance and the relationship with depth. Here we use `sim_ays_covar` and `sim_parabola` to control these relationships and a wide range of age and year specific distributions can be obtained by tweaking a few parameters in these closures. Below we run a default `sim_distribution` call, which generates a population that forms tight clusters that are more strongly correlated across years than ages, and another call that generates a population that is more diffuse (i.e. wider range) and exhibits stronger correlation across ages than years. Distributions can also be forced to be the same across ages and years by using the `group_ages` and `group_years`, respectively, arguments in the `sim_ays_covar` closure. In other words, these parameters can be modified to control the degree of age-specific clustering and inter-annual site-fidelity exhibited by the simulated population. Note that the resolution of the default grid is high and, as such, the simulations below may take minutes to complete. Also note that the key functions in the SimSurvey package have been set-up to be pipe [`%>%`; @bache2014] friendly.

```{r, echo = TRUE, eval = replot}

set.seed(438)
a <- sim_abundance() %>% 
  sim_distribution(ays_covar = sim_ays_covar(range = 300,
                                             phi_year = 0.9,
                                             phi_age = 0.5))
b <- sim_abundance() %>% 
  sim_distribution(ays_covar = sim_ays_covar(range = 2000,
                                             phi_year = 0.2,
                                             phi_age = 0.9))

```

This function retains all the data simulated by `sim_abundance` and adds a data.table [@dowle2017], named `sp_N`, with abundance (`N`) split by `age`, `year` and `cell`. The function also retains the grid object and converts these data into a data.table, named `grid_xy`, with headers `x`, `y`, `depth`, `cell`, `division` and `strat`. The `sp_N` object can be merge with the `grid_xy` data by `cell` to associate abundance with specific locations, depth, divisions or strata. The `plot_distribution` function can be used to provide a quick visual of the distribution across ages and years. The code below will generate interactive plots with an Age-Year slider, however, for this paper we present a facet plot of the simulated data in Figure \@ref(fig:distribution).

```{r, echo = TRUE, eval = FALSE}

plot_distribution(a, ages = 1:3, years = 1:3, type = "heatmap")
plot_distribution(b, ages = 1:3, years = 1:3, type = "heatmap")

```


```{r, eval = replot}

facet_distribution <- function(data) {
  ay <- expand.grid(age = 1:3, year = 1:3)
  plot_list <- vector("list", nrow(ay))
  for (i in 1:3) {
    for (j in 1:3) {
      p <- plot_distribution(data, ages = i, years = j, type = "heatmap") %>% 
        hide_colorbar() %>% 
        layout(autosize = FALSE, width = 100, height = 100,
               margin = list(l = 0, r = 0, b = 0, t = 0, pad = 0))
      plot_list[[which(ay$age == i & ay$year == j)]] <- p
    }
  }
  subplot(plot_list, nrows = 3, shareX = TRUE, shareY = TRUE, margin = 0.01) %>% 
    layout(autosize = FALSE, width = 300, height = 300,
           margin = list(t = 20, l = 20, b = 10, r = 10))
} 

a_plots <- facet_distribution(a)
b_plots <- facet_distribution(b)

p <- subplot(a_plots, b_plots) %>% 
  add_labels(text = rep(c("Age 1", "Age 2", "Age 3"), 2), x = c(0.04, 0.20, 0.4, 0.6, 0.8, 0.95), y = rep(0.995, 6), yshift = 20) %>% 
  add_labels(text = rep(c("Year 3", "Year 2", "Year 1"), 2), x = c(rep(0.005, 3), rep(0.54, 3)), y = c(0.08, 0.5, 0.92), xshift = -20, textangle = -90) %>% 
  add_labels(text = "a)", x = 0, y = 1, yshift = 20, xshift = -20) %>% 
  add_labels(text = "b)", x = 0.54, y = 1, yshift = 20, xshift = -20)

export_plot(p, file = "analysis/paper/figures/plot_distribution.png", width = 600, height = 300)

```


```{r distribution, fig.cap = "- Distribution plots of simulated populations that form a) tight clusters with stronger correlation through years than ages (case study settings), and b) relatively diffuse clusters with stronger correlation through ages than years. This plot is a facet of plots produced by `plot_distribution` when supplied simulations from `sim_distribution`."}

knitr::include_graphics("figures/plot_distribution.png")

```


## Simulate survey

The final step in the simulation is to conduct a stratified random survey over the age-year-space array generated using formula described above. The area of each strata is calculated and this is used to define the sets to allocate to each strata under a particular set density, $D_{sets}$. The allocated number of cells are randomly selected in each strata and the number of fish caught in each set is calculated by applying binomial sampling of the fish in each sampled cell by the proportion of the area covered by the trawl and the catchability of each age:

$$n_{a,y,s} \sim Bin(N_{a,y,s}, \frac{A_{trawl}}{A_{cell}} q_a )$$
Where $n_{a,y,s}$ is the number of fish sampled by a set, $A_{trawl}$ indicates the area covered by the trawl, $A_{cell}$ is the area of a grid cell (i.e. $R^2$), and $q_a$ is the catchability coefficient of each age. Here, catchabilities were defined using a logistic curve controlled by a steepness, $k$, and midpoint parameter, $x_0$. The lengths of the fish sampled by the set are then simulated using the von Bertalanffy growth equation found above in the [Simulate abundance] section. Depending on the number of fish caught, sub-sampling is then conducted. Specifically, a maximum number of lengths are measured per set, $M_{lengths}$, and a maximum number of ages, $M_{ages}$, are sampled per length group, $l_{group}$, per division. 

The function `sim_survey` can be used to simulate data from one survey over a population simulated using `sim_distribution`. This function simulates the sampling process of the survey and, as such, requires a closure for defining catchability as a function of age and definitions of the design of the survey. Specifically, the `q` argument requires a closure, such as `sim_logistic`, for defining the probability of catching specific age groups, trawl dimensions are defined in the `trawl_dim` argument, and set, length and age sampling effort are defined using the `set_den`, `lengths_cap` and `ages_cap` arguments, respectively. Multiple simulations of the same survey can be run using the `n_sims` argument, however, it is important not to request large numbers of simulations because this function can quickly deplete a computers RAM. Defaults used in the function and for the case study roughly correspond to the assumed catchability in NAFO division 3Ps as well as the sampling protocol used in the survey of this stock (Table \@ref(tab:par)). Below we use `sim_survey` to simulate two surveys over our case study population, of which one is set-up to have higher sampling effort than the other.

```{r, echo = TRUE, eval = replot}

set.seed(438)
pop <- sim_abundance() %>% 
  sim_distribution()
a <- pop %>% 
  sim_survey(n_sims = 5,
             set_den = 1 / 1000,
             lengths_cap = 100,
             ages_cap = 5)
b <- pop %>% 
  sim_survey(n_sims = 5,
             set_den = 5 / 1000,
             lengths_cap = 500,
             ages_cap = 25)

```

Again, this function retains all the objects listed in the output of `sim_distribution` and adds data.tables that detail the set locations (`setdet`) and sampling details (`samp`). Catchability corrected abundance matrices, named `I` and `I_at_length`, are also produced and added to the output; these matrices are useful for comparing the true abundance available to the survey to abundance estimates obtained using survey-based or model-based analyses of the simulated survey data. Specific surveys can be explored using the `plot_survey` function, which uses plotly [@sievert2018] and crosstalk [@cheng2016] in the background to link the bubble plot of aggregate set catch to the histogram of lengths and ages sampled to facilitate explorations of set-specific catches. The plots generated below have been combined here into a static plot for this paper (Figure \@ref(fig:survey)).

```{r, echo = TRUE, eval = FALSE}

plot_survey(a, which_sim = 1, which_year = 20)
plot_survey(b, which_sim = 1, which_year = 20)

```


```{r eval = replot}

plot_a <- plot_survey(a, which_sim = 1, which_year = 20) %>% 
  add_labels(text = "a)", x = 0, y = 1, yshift = 5, xshift = -5) %>% 
  layout(margin = list(l = 10, r = 10, t = 10, b = 10))
plot_b <- plot_survey(b, which_sim = 1, which_year = 20) %>% 
  add_labels(text = "b)", x = 0, y = 1, yshift = 5, xshift = -5) %>% 
  layout(margin = list(l = 10, r = 10, t = 10, b = 10))

## plotly::subplot was not amenable to combining these two plots, I therefore used ImageMagick to combine a and b

paths <- c(a = "analysis/paper/figures/plot_survey_a.png", b = "analysis/paper/figures/plot_survey_b.png")
export_plot(plot_a, file = paths["a"], width = 800, height = 400)
export_plot(plot_b, file = paths["b"], width = 800, height = 400)

image_a <- magick::image_read(paths["a"])
image_b <- magick::image_read(paths["b"])
p <- magick::image_append(c(image_a, image_b), stack = TRUE)
magick::image_write(p, path = "analysis/paper/figures/plot_survey.png")

```


```{r survey, fig.cap = "- Bubble plots and histograms of set catches from a simulated stratified-random survey of the case study population under relatively a) high and b) low sampling effort. Histograms of length and age composition include the distribution caught and sampled overlaid with a line of the true distribution of length and ages available to the survey. Note that the first simulation of the survey in year 20 is depicted here. These plots are produced by `plot_survey` when supplied survey data simulated using `sim_survey`."}

knitr::include_graphics("figures/plot_survey.png")

```

As noted above, the amount of RAM a user's computer has may limit the utility of the `sim_survey` function for running thousands of simulations of the same survey. The `sim_survey_parallel` function was therefore constructed to facilitate the running of thousands of simulations without running into RAM limitations. This function is set-up to run multiple `sim_survey` calls in parallel using the doParallel package [@weston2015] and, as such, multiple loops can be run using the `n_loops` argument and within each loop multiple simulations can be run (controlled using the `n_sims` argument). Total simulations will be the product of `n_loops` and `n_sims` arguments. If more than one core (`cores`) is specified, then the simulations will be run in parallel to speed up the process. Low numbers of `n_sims` and high numbers of `n_loops` will be easier on RAM, but may be slower. The optimum ratio of `n_sims` to `n_loops` will depend on the amount of RAM and number of cores the user's computer has. In any case, this function simplifies the process of running thousands of simulations of the same survey and the simulated data can then be supplied to survey-based or model-based analyses that require simulation testing. 

## Stratified analysis

Once the survey data are simulated, they then need to be analyzed to obtain an index of abundance. While there are many model-based options for obtaining an index [e.g. @Thorson2015], survey-based approaches, such as stratified analyses, are often used. Here we apply formula presented in Smith and Somerton [-@Smith1981] to calculate stratified estimates of total abundance ($\hat{I}_{y,k}$), abundance at length ($\hat{I}_{l,y,k}$) and abundance at age ($\hat{I}_{a,y,k}$). Note that estimates of total abundance are based on aggregate catch while abundance at length requires length frequencies to be bumped up using set-specific ratios of measured to caught fish, and these length frequencies are converted to age by applying a division-level age-length-key. We used root-mean-squared error (RMSE) as a measure of the precision and bias of the abundance at age estimates from each survey:

$$RMSE = \sqrt{\frac{ \sum_{a = 1}^{N_a} \sum_{y = 1}^{N_y} \sum_{k = 1}^{N_k} (\hat{I}_{a,y,k} - I_{a,y})^2}{N_a N_y N_k}}$$

Where $N_a$, $N_y$, and $N_k$ are the number of years, ages and simulations, respectively, and $I_{a,y}$ is the true abundance available to the survey (i.e. catchability corrected abundance; $I_{a,y} = q_a N_{a,y}$). RMSE was also calculated for abundance at length estimates, where the above formula is indexed by length groups $l$, and total abundance, which lacks a group index of $a$ or $l$.

Stratified estimates of abundance obtained are by supplying the output from `sim_survey` to the `run_strat` function. RMSE of the stratified estimates can then be calculated using the `strat_error` function. Results and error of a stratified analysis of one default survey over a default population are obtained using the following code:

```{r, echo = TRUE, eval = FALSE}

set.seed(438)
sim <- sim_abundance() %>% 
  sim_distribution() %>% 
  sim_survey() %>% 
  run_strat() %>% 
  strat_error()

```

The returned object will include all the objects accumulated through the `sim_abundance` to `strat_error`. The `run_strat` function adds three data.tables called `total_strat`, `length_strat` and `age_strat` that include stratified estimates of total abundance, abundance at length, and abundance at age, respectively. To this, `strat_error` adds data.tables ending with `_strat_error` or `_strat_error_stats`. The `_strat_error` objects simply contain stratified estimates of abundance (column named `I_hat`) with corresponding true values of abundance available to the survey (column named `I`) and the `strat_error_stats` data.frame includes metrics of mean absolute error (`MAE`), mean-squared error (`MSE`) and root-mean-squared error (`RMSE`).

## Testing survey protocol

Assuming a stratified analysis as the default method for obtaining an index of abundance, a series of survey protocol can be tested using the `test_surveys` function. Provided a simulated population from `sim_distribution` and a series of survey protocol from `expand_surveys`, this function will simulate and analyze data from each survey using the `sim_survey`, `run_strat` and `strat_error` functions. Like `sim_survey_parallel`, this function operates in parallel and allows the specification of `n_sims` and `n_loops`, and the product of these two arguments equals the number of times each survey is simulated. Keep in mind that low numbers of `n_sims` and high numbers of `n_loops` will be easier on RAM, but may be slower, especially if the work is spread across few `cores`. Because most of the default settings of the functions match the case study settings, the below code will replicate the results from our case study (see Table \@ref(tab:par) for a more detail). The `expand_surveys` function sets up a series of `r nrow(expand_surveys())` surveys to test (i.e. all possible combinations of `set_den`, `lengths_cap` and `ages_cap` protocol) and the `test_surveys` function will run 1000 simulations of each survey and compare stratified estimates of abundance to the true abundance available to the survey.

```{r, echo = TRUE, eval = FALSE}

set.seed(438)
pop <- sim_abundance() %>%
  sim_distribution()

surveys <- expand_surveys(set_den = c(0.0005, 0.001, 0.002, 0.005, 0.01),
                          lengths_cap = c(5, 10, 20, 50, 100, 500, 1000),
                          ages_cap = c(2, 5, 10, 20, 50))

tests <- test_surveys(pop, surveys = surveys,
                      n_sims = 5, n_loops = 200, cores = 2)

```

```{r data, eval = replot}

load("analysis/cod_sim_exports/2018-10-26_age_clust_test/test_output.RData")
tests <- sim

```

Processing time will system (i.e. amount of RAM and number of cores) and setting (i.e. `n_loops` and `n_sims` ratio) dependent. The `test_survey` function will print a progress bar, generated using the progress package [@csardi2016], which details percent completion and will also include an eta after the first step of the loop completes. Keep in mind that thousands of simulations of hundreds of survey designs may take days to run. The `test_surveys` function therefore includes an option for exporting intermediate results to a local directory, via the `export_dir` argument, and the `resume_test` function can be used resume a `test_surveys` run that had to be stopped part way through the process. The final object produced will be a list that includes all objects from `sim_abundance` and `sim_distribution` with the table of survey designs tested (named `surveys`) and tables produced by `strat_error` that end with the names `_strat_error` and `_strat_error_stats`. These tables include a `survey` column to allow merging of the survey protocol table with the error tables. Objects produced by `sim_survey` (set and sampling details) and `run_strat` (full stratified analysis results) are not retained to minimize object size. Like other core functions, some convenience functions are included in SimSurvey for creating interactive plots of the results from `test_surveys`. For instance a series of plotting functions ending in `_fan` produces fan charts where stratified estimates of abundance from each simulated survey are converted into a series of quantiles to depict the probability that estimates fall within a particular range. True values of abundance available to the survey are overlaid on the series of probability envelopes. These plots help visually assess the level of precision and bias from a specific set of survey protocol. The three lines of code below will produce interactive fan charts for stratified estimates of total abundance, abundance at length and abundance at age, respectively. A subset of these plots have been combined into static plots (Figure \@ref(fig:fan1), \@ref(fig:fan2), \@ref(fig:fan3)).

```{r, echo = TRUE, eval = FALSE}

plot_total_strat_fan(tests)
plot_length_strat_fan(tests, years = 1:20, lengths = 1:100)
plot_age_strat_fan(tests, years = 1:20, ages = 1:10)

```


```{r eval = replot}

surveys <- tests$surveys
set_dens <- c(0.0005, 0.002, 0.01)
i <- surveys$survey[surveys$set_den == set_dens[1] & surveys$lengths_cap == 10 & surveys$ages_cap == 10] # lengths_cap and ages_cap does not matter here
a <- plot_total_strat_fan(tests, surveys = i)
i <- surveys$survey[surveys$set_den == set_dens[2] & surveys$lengths_cap == 10 & surveys$ages_cap == 10]
b <- plot_total_strat_fan(tests, surveys = i)
i <- surveys$survey[surveys$set_den == set_dens[3] & surveys$lengths_cap == 10 & surveys$ages_cap == 10]
c <- plot_total_strat_fan(tests, surveys = i)

p <- subplot(a, b, c, nrows = 1, shareY = TRUE, titleX = FALSE) %>% 
  add_labels(x = 0.5, y = 0, text = "Year", yshift = -40) %>% 
  add_labels(x = c(0.1, 0.5, 0.9), y = rep(1, 3), yshift = 20, 
             text = paste("D<sub>sets</sub> =", set_dens))

export_plot(p, file = "analysis/paper/figures/plot_total_strat_fan.png", width = 700, height = 250)

```


```{r fan1, fig.cap = "- Fan chart of stratified estimates of the trend in total abundance from surveys with different set densities, $D_{sets}$. The heavy dark line indicates the true tred in the total population available to the survey and the color gradient represents a range of probability envelopes from 10% to 90%. This plot is a facet of plots produced by `plot_total_strat_fan` when supplied results from `test_surveys`."}

knitr::include_graphics("figures/plot_total_strat_fan.png")

```


```{r eval = replot}

facet_fan <- function(data, ages = NULL, lengths = NULL, ylim = NULL, set_dens = c(0.0005, 0.002, 0.01), lengths_caps = c(10, 100, 1000)) {
  surveys <- data$surveys
  s <- expand.grid(set_den = set_dens, lengths_cap = lengths_caps)
  plot_list <- vector("list", nrow(s))
  for (i in seq_along(set_dens)) {
    for (j in seq_along(lengths_caps)) {
      s_i <- surveys$survey[surveys$set_den == set_dens[i] & surveys$lengths_cap == lengths_caps[j] & surveys$ages_cap == 10]
      if (is.null(ages)) {
        p <- plot_length_strat_fan(data, surveys = s_i, years = 7, lengths = lengths) %>% 
         layout(yaxis = list(range = ylim))
      } else {
        p <- plot_age_strat_fan(data, surveys = s_i, years = 7, ages = ages) %>% 
          layout(yaxis = list(range = ylim))
      }
      plot_list[[which(s$set_den == set_dens[i] & s$lengths_cap == lengths_caps[j])]] <- p
    }
  }
  subplot(plot_list, nrows = length(set_dens), shareX = TRUE, shareY = TRUE, titleX = FALSE, titleY = FALSE)
} 

p <- facet_fan(tests, lengths = 1:100, ylim = c(0, 21000000)) %>% 
  layout(margin = list(r = 30)) %>% 
  add_labels(x = c(0.1, 0.5, 0.9), y = rep(1, 3), yshift = 20, 
             text = paste("D<sub>sets</sub> =", c(0.0005, 0.002, 0.01))) %>% 
  add_labels(x = rep(1, 3), y = c(0.05, 0.5, 0.95), xshift = 30, textangle = 90,
             text = paste("M<sub>lengths</sub> =", rev(c(10, 100, 1000)))) %>% 
  add_labels(x = 0.5, y = 0, text = "Year", yshift = -40) %>% 
  add_labels(x = 0, y = 0.5, text = "Abundance index", xshift = -60, textangle = -90)

export_plot(p, file = "analysis/paper/figures/plot_length_strat_fan.png", width = 700, height = 600)

```


```{r fan2, fig.cap = "- Fan chart of stratified estimates of abundance at length from year seven of the simulation from surveys with different set densities, $D_{sets}$, and length sampling protocol, $M_{lengths}$. The heavy dark line indicates the true tred in the total population available to the survey and the color gradient represents a range of probability envelopes from 10% to 90%. This plot is a facet of plots produced by `plot_total_strat_fan` when supplied results from `test_surveys`."}

knitr::include_graphics("figures/plot_length_strat_fan.png")

```

```{r, eval = replot}

p <- facet_fan(tests, ages = 1:10, ylim = c(0, 51000000)) %>% 
  layout(margin = list(r = 30)) %>% 
  add_labels(x = c(0.1, 0.5, 0.9), y = rep(1, 3), yshift = 20, 
             text = paste("D<sub>sets</sub> =", c(0.0005, 0.002, 0.01))) %>% 
  add_labels(x = rep(1, 3), y = c(0.05, 0.5, 0.95), xshift = 30, textangle = 90,
             text = paste("M<sub>lengths</sub> =", rev(c(10, 100, 1000)))) %>% 
  add_labels(x = 0.5, y = 0, text = "Year", yshift = -40) %>% 
  add_labels(x = 0, y = 0.5, text = "Abundance index", xshift = -60, textangle = -90)

export_plot(p, file = "analysis/paper/figures/plot_age_strat_fan.png", width = 700, height = 600)

```


```{r fan3, fig.cap = "- Fan chart of stratified estimates of the trend in abundance at age four from surveys with different set densities, $D_{sets}$, and length sampling protocol, $M_{lengths}$. Number of ages sampled per length group, $M_{ages}$, was 10 in all scenarios. The heavy dark line indicates the true tred in the total population available to the survey and the color gradient represents a range of probability envelopes from 10% to 90%. This plot is a facet of plots produced by `plot_total_strat_fan` when supplied results from `test_surveys`."}

knitr::include_graphics("figures/plot_age_strat_fan.png")

```


The relative performance of the surveys tested can be compared using `plot_survey_rank` and `plot_error_surface`. The `plot_survey_rank` function produces a divergent dot plot of the results which ranks the surveys by RMSE. Using the `wich_strat` argument, the plot can be focused on total, length or age based stratified results. The `plot_error_surface` focuses solely on the age based stratified results by plotting a surface of RMSE (z-axis) by set (drop down selection), length (y-axis) and age (z-axis) sampling effort. The sampling effort axes can be rule or sample size based (`plot_by = "rule"` or `plot_by = "samples"`, respectively). See figures \@ref(fig:rank) and \@ref(fig:rmse-surface) for examples of the output from the code below.

```{r, echo = TRUE, eval = FALSE}

plot_survey_rank(tests, which_strat = "length")
plot_error_surface(tests, plot_by = "rule")

```


```{r, eval = replot}

sim <- tests
sim$surveys <- sim$surveys[sim$surveys$set_den %in% c("0.01", "0.002", "0.0005")]

p <- plot_survey_rank(sim, which_strat = "length")
export_plot(p, file = "analysis/paper/figures/plot_survey_rank.png", width = 450, height = 400)

totals <- sim$samp_totals[, list(n_sets = mean(n_sets), n_caught = mean(n_caught),
                                 n_measured = mean(n_measured), n_aged = mean(n_aged)),
                          by = "survey"]
errors <- merge(sim$surveys, sim$age_strat_error_stats, by = "survey")
d <- merge(errors, totals, by = "survey")

split_d <- split(d, d$set_den)
x <- sort(unique(d$ages_cap))
y <- sort(unique(d$lengths_cap))

scene <- list(
  xaxis = list(title = "Ages cap"),
  yaxis = list(title = "Lengths cap"),
  zaxis = list(title = "RMSE"),
  camera = list(eye = list(x = 1.5, y = 1.5, z = 1.5))
)

xshift <- c(-30, 0, 30)
p_list <- lapply(seq_along(split_d), function(i) {
  scene <- paste0("scene", i)
  z <- stats::xtabs(RMSE ~ ages_cap + lengths_cap, data = split_d[[i]], subset = NULL)
  plot_ly(x = x, y = y, scene = scene) %>% add_surface(z = t(z), showscale = FALSE) %>% 
    add_labels(x = 0.5, y = 1, text = paste("D<sub>sets</sub> =", names(split_d[i])), 
               yshift = -20, xshift = xshift[i])
})

p <- subplot(p_list) %>%  
  layout(scene = c(list(domain = list(x = c(0, 1/3), y = c(0, 1))), scene),
         scene2 = c(list(domain = list(x = c(1/3, 2/3), y = c(0, 1))), scene),
         scene3 = c(list(domain = list(x = c(2/3, 1), y = c(0, 1))), scene),
         autosize = FALSE, margin = list(t = 0, l = 10, r = 10, b = 10))
  
export_plot(p, file = "analysis/paper/figures/plot_error_surface.png", width = 990, height = 270)


```


```{r rank, fig.cap = "- Divergent dot plot of the percision and accuracy (RMSE) of length based stratified estimates of abundance, and total sampling effort (number of sets [$N_{sets}$] and length measurements [$N_{measured}$]), under various sampling protocol (set density [$D_{sets}$] and maximum number of lengths measured per set [$M_{lengths}$])."}

knitr::include_graphics("figures/plot_survey_rank.png")

```

```{r rmse-surface, fig.cap = "- Surface plots of RMSE from an array of surveys with different sampling protocol. Panels represent surveys with different set densities ($D_{sets}$), x-axes represent the maximum sampling effort of lengths per set ($M_{lengths}$), and y-axes represent the maximum number of ages to collect per length group ($M_{ages}$). This plot is a facet of plots produced by `plot_error_surface` when supplied results from `test_surveys`. Note that the z-axes scales are different across the facets."}

knitr::include_graphics("figures/plot_error_surface.png")

```



## Assumptions

Like any model, this simulation is a simplification of a much more complex reality. For instance, the population is assumed to aggregate by age-class and be uniformly distributed within a cell when, in the real-world, they may aggregate by length and form finer-scale clusters. The survey is also an instantaneous snapshot of the population, meaning that the population is assumed to be in the same location from the beginning to the end of the survey. Also, fish are aged at random within length bins and ages are estimated without error. Finally, area trawled is assumed to be perfectly standard. This is a short, non-inclusive, list of additional variability that likely occurs in the real-world but was not implemented here for simplicity. Nevertheless, the SimSurvey package provides the most realistic operating model that we are aware of for simulating stratified-random survey data from a population that varies across age, year and space dimensions.


# Results

The SimSurvey package serves as a tool for simulating stratified random surveys of dynamic populations that vary across ages, time and space. The core of the simulation is based on the widely used cohort equation and, even though the processes that define recruitment and total mortality are simple, a wide range of stock dynamics can be simulated by changing a few parameters (Figure \@ref(fig:surface)). This base population can then be distributed through a grid (Figure \@ref(fig:grid)) and relationships with depth can be defined as can the nature of the correlation across ages, years and space (Figure \@ref(fig:distribution)). Together, two functions (`sim_abundance` and `sim_distribution`) are capable of simulating a wide range of populations with different life histories, depth associations and spatial properties. The next necessary step to generating data similar to actual observations is to conduct a survey. In this package we implement a function, `sim_survey`, that conducts a stratified random survey of the population. The sampling process is governed by the area covered by the trawl as well as age-specific catchability. Sub-sampling protocol (length and age sampling) can also be varied. As such, data from a wide range of surveys can be simulated (Figure \@ref(fig:survey)). There are a plethora of statistical models that may be tested using these simulated data, however, implementing a variety of analylitical approaches was outside the scope of this work. Insted we focus on analyzing simulated stratified-random survey data using a design-based stratified analysis. A stratified analyis is facilitated using the `run_strat` function and the precision and accuracy of the results (e.g. RMSE) can be calculated using `strat_error`. This is a simple and widly-used analysis, and the speed at which it runs allows for a wide range of survey designs to be tested, via the `test_surveys` function, in a reasonable timeframe.

Results from the case study presented provide one example of how this package can be used to explore the effacacy of various survey designs. A dynamic population with a patchy and age-clustered distribution was simulated for this case study (Figure \@ref(fig:surface)a, \ref(fig:distribution)a). In general, the parameter settings used (function defaults) dictate that all ages tend to aggregate in fairly dense clusters and that low-density zones are relatively wide-ranging. Surveys, therefore, tend to be characterized by regions with large catches interspersed with regions of no catch (Figure \@ref(fig:survey)). The samples within each successful set are also dynamic and rarely include all age groups. This is because only moderate correlation ($\varphi_{\xi, age}$ of 0.5) was imposed on the distributions of ages 1-5+, allowing individuals of different ages to occupy different locations. These settings were chosen to simulated data that roughly correspond to actual survey data of cod from NAFO division 3Ps, where cod between the ages of 1-5 tend to be caught at different locations.

A series of surveys were run over the simulated population (see `expand_surveys` call in Table \@ref(tab:par)) and stratified analyses were run on the data obtained. The stratified analyses provided estimates of total abundance, abundance at length and abundance at age, and different stages of sampling affect these estimates. Specifically, set density affects all estimates, length sampling affects estimates of abundance at length and abundance at age, and age sampling affects abundance at age estimates. This is because stratified estimates of total abundance is based on aggregate catch while abundance at length estimates requires both total and length frequency data; finally, abundance at age estimates requires set totals, and length and age data to construct an age-length key. 

The effect of set density on estimates of total abundance, abundance at length and abundance at age are clear across all figures generated from the `test_surveys` results (Figures \@ref(fig:fan1), \@ref(fig:fan2), \@ref(fig:fan3), \@ref(fig:rank), \@ref(fig:rmse-surface)). Across all fan plots, it is clear that the probability envelopes tighten (i.e. estimates are more precise) as set density is increased (Figures \@ref(fig:fan1), \@ref(fig:fan2), \@ref(fig:fan3)). Clear declines in RMSE are also apparant in estimates of abundance at length as set density is increased (Figure \@ref(fig:rank)) and there are notable differences in the scale of RMSE in estimates of abundance at age as set density is increased (Figure \@ref(fig:rmse-surface)). 

Compared to increases in set density, the effects of increased length sampling effort on abundance at length estimates are less clear. Regarding estimates of abundance at length, RMSE appears to reach a platau at when length sampling effort is increased 100 measurements per set (Figure \@ref(fig:rank)). Increasing the sampling rule above 100 measurements per set results in many more fish being measured, however, the increase in sampling effort is not matched with substantive declines in RMSE (Figure \@ref(fig:rank)). Interestingly, it appears that measuring fewer total fish at more locations appears to be more benificial than many fish at fewer locations (Figure \@ref(fig:rank)).

All levels of sampling affect the abundance at age estimates as set catches define the maginitude of the population, length sampling define the length distribution and data from the length-stratified age sampling is used to construct an age-length-key to convert length frequenceis to age frequencies. Like the abundance at length estimates, the greatest improvements to RMSE come from increasing set density rather than sub-sampling effort (Figure \@ref(fig:rmse-surface)). Specifically, decreasing the age sampling protocol below 10 ages sampled per length group per division appears to result in relatively small increases to RMSE (Figure \@ref(fig:rmse-surface)). Lenght sampling effort, in contrast, has an uneven impact depending on the set density scenario. At low set densities ($D_{sets}$ = 0.0005 sets / km^2^), RMSE declines when length sampling effort is increased from around 5 to around 100 measurements per set, and RMSE starts to increase as length sampling effort is increased beyond ~100 measurements per set; in fact, RMSE values appear higher at the highest length sampling scenario (1000 measurements / set) than the lowest (5 measurements / set; Figure \@ref(fig:rmse-surface)). A similar pattern is apparant under the medium set density scenario ($D_{sets}$ = 0.002 sets / km^2^), however, RMSE values under the lowest and highest length sampling scenarios are of similar magnitude. Finally, RMSE continues to decline with increased length sampling effort under the high set density scenarios ($D_{sets}$ = 0.01 sets / km^2^; Figure \@ref(fig:rmse-surface)).


# Discussion

While there are several simulation frameworks for testing the design of fisheries-independent trawl surveys [e.g. @puerta2019; @schnute2003], there are few tools that facilitate such work. Here we document an R package with a series of functions for testing the multi-layred sampling design of spatial, age-structured populations. The package can also serve as a medium for the simulation testing of methods for analyzing such data. "Good survey design is a crucial prerequisite for obtaining reliable results" [@thomas2010]...

The simple simulation presented here revealed some expected and unexpected patterns. First, there were clear improvements to precision in all population estimates as the number of sets were increased. This result was expected as it aligns with a basic principle of survey design that the precision and representativeness of a survey increases as the number of sampling units are increased [@sutherland2006]. Second, stratified estimates of abundance at age were often biased and, in some cases, estimates were poorer when sub-sampling effort was increased. This result was unexpected because design-based estimators, such as the stratified analysis applied here, are expected to be unbiased [@smith1990] and increases to sub-sampling effort was expected to be relatively ineffective, not detrimental. Results from stratified estimates of abundance at length, in contrast, better align with these expectations. By deduction, these results indicate that the issue stems from the intervening age-length key and not the design-based estimator.

Using an age-length key in conjunction with the length distribution to estimate abundance at age is standard procedure in the analysis of fisheries-independent survey data as only a small fraction of the catch is typically aged. This is because the aging procedure is costly and time-consuming whereas length measurements are relatively easy to obtain. Ages are generally determined from length-stratified sub-samples of the catch and raw proportions of age-at-length are used to assign ages to fish in specific length groups. Age-length keys are usually constructed at larger spatial scales because there are rarely enough samples to stratify these data. Here we construct one age-length key for the division, as is done for the analysis of 3Ps cod. There is, however, a potential cost to the spatial scale of the key. Namely, it is unlikely that one age-length key is representative for the whole region because the probability of being a specific age given length varies in space [@Berg2012]. This would not be an issue if there was no size (age) specific clustering, however, this may not always be the case because different size groups often occur in different places because of ontogenetic habitat shifts [@dahlgren2000; @galaiduk2017]. For instance, it is not uncommon for populations to form distinct nursery and spawning areas [@marteinsdottir2000; @booth2000]. Because different age groups sometimes occur in different places, the translation of lengths to ages may be biased by the samples used to generate the age-length key. This bias is perhaps compounded by the length-stratified sampling of ages such that the ages sampled may be skewed towards sets with the most catch, especially under scenarios where length sampling effort is high. If this is the case, then the representativeness of the age-length key to the whole population could be diminished by excessive length sampling. 

The negative consequences of excessive length sampling on abundance at age estimates are most apparent under the low set density scenarios. The precision of the estimates are also the poorest when fewer sets are conducted. Sets, however, are the most costly sample to obtain and, as such, the set densities of fisheries-independent surveys tend to be on the lower end of the scenarios presented in this paper. The set density of the multi-species survey conducted by Fisheries and Oceans Canada in the Newfoundland region, for instance, ranges between 0.001 and 0.002 sets / km^2^. Length sampling effort, in contrast, tends to be on the higher end of the scenarios presented here because lengths are relatively cheap and easy to obtain. Again, using Fisheries and Oceans Canada sampling protocol from the Newfoundland region as an example, it is not uncommon for length sampling effort to be capped at 500 measurements per set. The results presented in this paper paradoxically suggest that better abundance at age estimates are obtained by lowering the length sampling cap. Results also indicate that reductions to length sampling effort would not significantly impact abundance at length estimates. Nonetheless, it is hard to be prescriptive because this simulation is far from a perfect reflection of reality and it focuses on one case study. Further research is required on the consequences of some of the assumptions of this simulation as well as the interaction between age-specific clustering, length-stratified sampling and the age-length key. Ideally, the simulation would also include multiple species with different life-histories and distributions, and also integrate a cost component to assess the trade-offs between information and cost. Finally, it would be interesting to test alternate analyses of these data that may account for the spatial structure of the age-length key [e.g. @Berg2012].

While much work has yet to be done, results from the simple simulation echo the growing body of literature which concludes that extra sub-sampling is an ineffective means of improving estimates relative to sampling more locations [@Pennington1994; @Pennington2002; @Stewart2014; @Bogstad1995; @Coggins2013; @Zhang2013]. In general, the most significant source of variation in fisheries-independent surveys stems from set-to-set variation, and not variability from individual sub-samples. This is largely because fish caught together tend to be more similar than those in the general population [@Pennington1994]. Therefore, if the goal of a trawl survey is to maximize information, it is likely better to stop collecting psudoreplicates and, instead, focus efforts on other species or the next set.

# Acknowledgements

- Feedback and advice: Aaron Adamack, Alejandro Buren, Noel Cadigan, Karen Dwyer, Geoff Evans, Brian Healey, Paul Higdon, Danny Ings, Mariano Koen-Alonso, Joanne Morgan, Keith Lewis, Derek Osborne, Pierre Pepin, Dwayne Pittman, Don Power, Greg Robertson, Martha Robertson, Mark Simpson, Brad Squires, Don Stansbury, Peter Upward
- Dave Cote for a review of a previous version of this manuscript
- NSERC visiting-fellow program


# Tables



<!-- # Figures -->

<!-- ```{r sp, cache = TRUE, fig.height = 3.8, fig.width = 8.5, fig.cap = "- An example from year seven of the simulation of a) the distribution of total abundance available to the survey, and b) locations of the sets conducted and total numbers caught in a stratified random survey with a set density of 0.002 sets / km^2^. Grey lines indicate depth-based survey strata."} -->

<!-- which_year <- 7 -->
<!-- which_sim <- 1 -->

<!-- sp_N_tot <- sim$sp_I[year == which_year & sim == which_sim, list(N = sum(I)), by = c("year", "cell")] -->
<!-- xyz <- merge(sim$grid_xy, sp_N_tot, by = "cell") -->
<!-- size <- unique(diff(pretty(xyz$N, 25))) -->

<!-- sp_strat <- raster::rasterToPolygons(sim$grid$strat, dissolve = TRUE) -->
<!-- df_strat <- suppressWarnings(fortify(sp_strat) %>% group_by(group)) -->

<!-- r <- raster::rasterFromXYZ(xyz[, c("x", "y", "N")]) -->
<!-- l <- rasterToContour(r, levels = pretty(xyz$N, 20)) -->
<!-- df_lines <- suppressWarnings(fortify(l)) -->
<!-- levels <- as.numeric(as.character(l$level)) -->
<!-- levels <- si(levels) -->
<!-- labs <- levels -->
<!-- labs[seq_along(labs) %% 2 == 0] <- "" -->
<!-- levels <- factor(levels, levels = levels) -->
<!-- names(levels) <- rownames(as.data.frame(l)) -->
<!-- df_lines$level <- levels[df_lines$id] -->

<!-- abun_plot <- ggplot() + -->
<!--   geom_path(data = df_strat, aes(x = long, y = lat, group = group),  -->
<!--             color = "grey", size = 0.05) + -->
<!--   geom_path(data = df_lines, aes(x = long, y = lat, group = group, color = level), -->
<!--             size = 0.3) + -->
<!--   scale_color_viridis(labels = labs, discrete = TRUE, name = "N") +  -->
<!--   scale_x_continuous(expand = c(0,0)) + -->
<!--   scale_y_continuous(expand = c(0,0)) + -->
<!--   coord_equal() + -->
<!--   theme_void() + guides(color = guide_legend(keywidth = 0.4, keyheight = 0,  -->
<!--                                              default.unit = "cm", ncol = 1)) + -->
<!--   theme(legend.justification = c(0, 1), -->
<!--         plot.margin = unit(c(0.1, 0.1, 0.1, 0.1), "cm")) -->

<!-- setdet <- sim$setdet -->
<!-- setdet <- setdet[setdet$year == which_year & setdet$sim == which_sim, ] -->
<!-- breaks <- pretty(setdet$n, 7) -->

<!-- set_plot <- ggplot() + -->
<!--   geom_path(data = df_strat, aes(x = long, y = lat, group = group),  -->
<!--             color = "grey", size = 0.05) + -->
<!--   geom_point(data = setdet, aes(x = x, y = y, size = n, color = n), alpha = 0.8) + -->
<!--   scale_size_area(name = "   n", max_size = 10, limits = range(breaks), breaks = breaks) + -->
<!--   scale_color_viridis(name = "   n", limits = range(breaks), breaks = breaks) +  -->
<!--   scale_x_continuous(expand = c(0,0)) + -->
<!--   scale_y_continuous(expand = c(0,0)) + -->
<!--   coord_equal() + -->
<!--   theme_void() + guides(color = guide_legend(keywidth = 0.4, keyheight = 0.2, default.unit = "cm")) + -->
<!--   theme(legend.justification = c(0, 1), -->
<!--         plot.margin = unit(c(0.1, 0.1, 0.1, 0.1), "cm")) -->

<!-- p <- cowplot::plot_grid(abun_plot, set_plot, labels = c("a)", "b)"), align = "hv", -->
<!--                    label_fontface = "plain") -->
<!-- cowplot::save_plot(plot = p, filename = "analysis/paper/figures/abun_and_sets_example.pdf", -->
<!--                    base_height = 3.8, base_width = 8.5) -->
<!-- p -->

<!-- ``` -->

<!-- <br> -->

<!-- ```{r tot, cache = TRUE, fig.width = 8, fig.height = 3, fig.cap = "- Fan chart of stratified estimates of the trend in total abundance from surveys with different set densities, $D_{sets}$. The heavy dark line indicates the true tred in the total population available to the survey."} -->

<!-- which_set_dens <- c(0.0005, 0.002, 0.01) -->
<!-- which_len_caps <- c(10, 100, 1000) -->

<!-- d <- merge(sim$surveys, sim$total_strat_error, by = "survey") -->
<!-- d <- d[d$set_den %in% which_set_dens &  -->
<!--          d$lengths_cap == 100 & d$ages_cap == 10, ] ## length and age sampling not a factor here -->

<!-- p <- fan_plot(d, x = "Year", which_strat = "Total") -->
<!-- cowplot::save_plot(plot = p, filename = "analysis/paper/figures/total_strat_true_vs_est.pdf", -->
<!--                    base_height = 3, base_width = 8) -->
<!-- p -->

<!-- ``` -->

<!-- <br> -->

<!-- ```{r length, cache = TRUE, fig.width = 8, fig.height = 6, fig.cap = "- Fan chart of stratified estimates of abundance at length from year seven of the simulation from surveys with different set densities, $D_{sets}$, and length sampling protocol, $M_{lengths}$. The heavy dark line indicates the true population available to the survey."} -->

<!-- which_set_dens <- c(0.0005, 0.002, 0.01) -->
<!-- which_len_caps <- c(10, 100, 1000) -->
<!-- which_year <- 7 -->

<!-- sub_surveys <- sim$surveys[sim$survey$set_den %in% which_set_dens & -->
<!--                              sim$survey$lengths_cap %in% which_len_caps &  -->
<!--                              sim$survey$ages_cap == 10, ] -->
<!-- sub_strat <- sim$length_strat_error[eval(sim$length_strat_error$survey %in% sub_surveys$survey & -->
<!--                                            sim$length_strat_error$year == which_year), ] -->
<!-- d <- merge(sub_surveys, sub_strat, by = "survey") -->
<!-- d$length[d$length > 100] <- 100 # aggregate beyond 100 cm -->
<!-- d <- d[, list(I_hat = sum(I_hat), I = sum(I)),  -->
<!--         by = c("year", "length", "sim", "survey", "set_den", "lengths_cap")] -->

<!-- p <- fan_plot(d, x = "Length", which_strat = "Length") -->
<!-- cowplot::save_plot(plot = p, filename = "analysis/paper/figures/true_vs_est_by_length.pdf", -->
<!--                    base_height = 6, base_width = 8) -->
<!-- p -->

<!-- ``` -->


<!-- ```{r age, cache = TRUE, fig.width = 8, fig.height = 6, fig.cap = "- Fan chart of stratified estimates of abundance at age from year seven of the simulation from surveys with different set densities, $D_{sets}$, and length sampling protocol, $M_{lengths}$. Number of ages sampled per length group, $M_{ages}$, was 10 in all scenarios. The heavy dark line indicates the true population available to the survey."} -->

<!-- which_set_dens <- c(0.0005, 0.002, 0.01) -->
<!-- which_len_caps <- c(10, 100, 1000) -->
<!-- which_year <- 7 -->

<!-- sub_surveys <- sim$surveys[sim$survey$set_den %in% which_set_dens & -->
<!--                              sim$survey$lengths_cap %in% which_len_caps &  -->
<!--                              sim$survey$ages_cap == 10, ] -->
<!-- sub_strat <- sim$age_strat_error[eval(sim$age_strat_error$survey %in% sub_surveys$survey & -->
<!--                                         sim$age_strat_error$year == which_year), ] -->
<!-- d <- merge(sub_surveys, sub_strat, by = "survey") -->
<!-- d <- d[d$year == which_year & d$set_den %in% which_set_dens & -->
<!--          d$lengths_cap %in% which_len_caps & d$ages_cap == 10, ] -->
<!-- d$age[d$age > 10] <- 10 # aggregate beyond 10 -->
<!-- d <- d[, list(I_hat = sum(I_hat), I = sum(I)),  -->
<!--        by = c("year", "age", "sim", "survey", "set_den", "lengths_cap")] -->

<!-- p <- fan_plot(d, x = "Age") -->
<!-- cowplot::save_plot(plot = p, filename = "analysis/paper/figures/true_vs_est_by_age.pdf", -->
<!--                    base_height = 6, base_width = 8) -->
<!-- p -->

<!-- ``` -->

<!-- <br> -->

<!-- ```{r year, cache = TRUE, fig.width = 8, fig.height = 6, fig.cap = "- Fan chart of stratified estimates of the trend in abundance at age four from surveys with different set densities, $D_{sets}$, and length sampling protocol, $M_{lengths}$. Number of ages sampled per length group, $M_{ages}$, was 10 in all scenarios. The heavy dark line indicates the true trend in the population available to the survey."} -->

<!-- which_set_dens <- c(0.0005, 0.002, 0.01) -->
<!-- which_len_caps <- c(10, 100, 1000) -->
<!-- which_age <- 4 -->

<!-- d <- merge(sim$surveys, sim$age_strat_error, by = "survey") -->
<!-- d <- d[d$age == which_age & d$set_den %in% which_set_dens & -->
<!--        d$lengths_cap %in% which_len_caps & d$ages_cap == 10, ] -->

<!-- p <- fan_plot(d, x = "Year") -->
<!-- cowplot::save_plot(plot = p, filename = "analysis/paper/figures/true_vs_est_by_year.pdf", -->
<!--                    base_height = 6, base_width = 8) -->
<!-- p -->

<!-- ``` -->

<!-- <br> -->

<!-- ```{r error-lines, cache = TRUE, fig.height = 3.8, fig.width = 8.5, results = "hide", fig.cap = "- Root-mean-squared error (RMSE) of abundance at length and abundance at age estimates as a function of the number of fish measured ($N_{lengths}$) from an array of surveys with different sampling protocol. The labels represent surveys with different set densities ($D_{sets}$), where number of sets are shown in brackets, and the lines are color coded by length sampling protocol ($M_{lengths}$). Number of ages sampled per length group, $M_{ages}$, was 10 in all scenarios."} -->

<!-- totals <- sim$samp_totals[, list(n_sets = mean(n_sets), n_caught = mean(n_caught), -->
<!--                                  n_measured = mean(n_measured), n_aged = mean(n_aged)), -->
<!--                           by = "survey"] -->

<!-- errors <- merge(sim$surveys, sim$length_strat_error_stats, by = "survey") -->
<!-- length_d <- merge(errors, totals, by = "survey") -->
<!-- length_d <- length_d[length_d$ages_cap == 10, ] -->
<!-- length_d$strat <- "Abundance at length" -->

<!-- errors <- merge(sim$surveys, sim$age_strat_error_stats, by = "survey") -->
<!-- age_d <- merge(errors, totals, by = "survey") -->
<!-- age_d <- age_d[age_d$ages_cap == 10, ] -->
<!-- age_d$strat <- "Abundance at age" -->

<!-- d <- rbind(length_d, age_d) -->
<!-- d$cap <- factor(d$lengths_cap) -->
<!-- d$strat <- factor(d$strat, levels = c("Abundance at length", "Abundance at age")) -->

<!-- lab_d <- d[lengths_cap == max(lengths_cap), -->
<!--            list(lengths_cap, n_measured, n_sets, cap, RMSE), -->
<!--            by = c("set_den", "strat")] -->
<!-- lab_d$lab <- paste0(formatC(lab_d$set_den), " (", lab_d$n_sets, ")") -->

<!-- p <- ggplot(data = d, aes(x = n_measured, y = RMSE, group = set_den)) + -->
<!--   geom_line(aes(color = cap), size = 2, lineend = "round") + -->
<!--   geom_text(data = lab_d, aes(label = lab), nudge_x = 500, hjust = 0) + -->
<!--   geom_point(data = lab_d, aes(color = cap)) + -->
<!--   xlab(bquote(N[lengths])) + -->
<!--   scale_y_continuous(labels = format_si()) + -->
<!--   scale_x_continuous(labels = format_si(), limits = c(0, max(d$n_measured) * 1.3), -->
<!--                      breaks = pretty(d$n_measured, 6)) + -->
<!--   scale_color_viridis(name = bquote(M[lengths]), discrete = TRUE) + -->
<!--   facet_wrap(~ strat, scales = "free", dir = "h") + -->
<!--   theme_bw() + -->
<!--   theme(legend.justification = c(0, 1), -->
<!--         plot.margin = unit(c(0.2, 0.2, 0.2, 0.2), "cm"), -->
<!--         panel.grid.major = element_blank(), -->
<!--         panel.grid.minor = element_blank(), -->
<!--         strip.background = element_blank(), -->
<!--         panel.border = element_rect(fill = NA, color = "darkgrey", size = 0.4), -->
<!--         axis.ticks = element_line(color = "darkgrey", size = 0.4)) -->

<!-- cowplot::save_plot(plot = p, filename = "analysis/paper/figures/error_lines.pdf", -->
<!--                    base_height = 3.8, base_width = 8.5) -->
<!-- p -->

<!-- ``` -->

<!-- <br> -->

<!-- ```{r error-wireframe, cache = TRUE, fig.height = 3, fig.width = 8.5, results = "hide", fig.cap = "- Wireframe plot of root-mean-squared error (RMSE) from an array of surveys with different sampling protocol. Panels represent surveys with different set densities ($D_{sets}$), x-axes represent the maximum sampling effort of lengths per set ($M_{lengths}$), and y-axes represent the maximum number of ages to collect per length group ($M_{ages}$)."} -->

<!-- trellis_theme <- list( -->
<!--   box.3d = list(col = "darkgrey"),  -->
<!--   axis.line = list(col = "transparent"), -->
<!--   strip.background = list(col = "transparent"),  -->
<!--   strip.border = list(col = "transparent"), -->
<!--    layout.heights = list( -->
<!--         top.padding = 0, -->
<!--         main.key.padding = 0, -->
<!--         key.axis.padding = 0, -->
<!--         axis.xlab.padding = 0, -->
<!--         xlab.key.padding = 0, -->
<!--         key.sub.padding = 0, -->
<!--         bottom.padding = -5 -->
<!--     ), -->
<!--     layout.widths = list( -->
<!--         left.padding = 0, -->
<!--         key.ylab.padding = 0, -->
<!--         ylab.axis.padding = 0, -->
<!--         axis.key.padding = 0, -->
<!--         right.padding = 1 -->
<!--     ) -->
<!-- ) -->

<!-- zscale_format <- function(lim, logsc = FALSE, ...) { -->
<!--     ans <- zscale.components.default(lim, logsc = logsc, ...) -->
<!--     ans$left$labels$labels <- si(ans$left$labels$at) -->
<!--     ans -->
<!-- } -->

<!-- d <- merge(sim$surveys, sim$age_strat_error_stats, by = "survey") -->
<!-- # d <- d[d$set_den != 0.0005, ] -->
<!-- d <- d[d$set_den %in% c(0.0005, 0.002, 0.01)] -->
<!-- set_den <- sort(unique(d$set_den)) -->
<!-- d$set_den <- factor(d$set_den) -->
<!-- options(scipen = 999) -->
<!-- labs <- sapply(seq_along(set_den), function(i) as.expression(bquote(D[sets] == .(set_den[i]))),  -->
<!--                USE.NAMES = FALSE) -->
<!-- zlabs <- list(at = pretty(d$RMSE), labels = si(pretty(d$RMSE))) -->

<!-- pdf("analysis/paper/figures/error_wireframe.pdf", height = 3, width = 8.5) -->

<!-- p <- wireframe(RMSE ~  lengths_cap * ages_cap | set_den, data = d, -->
<!--           as.table = TRUE, drape = TRUE, col = "white", lwd = 0.5, -->
<!--           strip = strip.custom(factor.levels = labs), -->
<!--           scales = list(arrows = FALSE, cex = 0.7, z = zlabs), -->
<!--           col.regions = viridis::viridis(100), -->
<!--           screen = list(z = 230, x = 300),  -->
<!--           xlab = list(expression(M[lengths]), rot = 25),  -->
<!--           ylab = list(expression(M[ages]), rot = -15),  -->
<!--           zlab = list("RMSE", rot = 95), -->
<!--           colorkey = list(labels = zlabs, height = 0.6, -->
<!--                           axis.line = list(col = "darkgrey")), -->
<!--           par.settings = trellis_theme) -->
<!-- p <- update(p, layout = c(3, 1)) -->
<!-- p -->
<!-- grid::grid.text("RMSE", x = unit(0.952, "npc"), y = unit(0.77, "npc")) -->

<!-- invisible(dev.off()) -->

<!-- p -->
<!-- grid::grid.text("RMSE", x = unit(0.952, "npc"), y = unit(0.77, "npc")) -->

<!-- ``` -->

<!-- <br> -->



# Appendix 1: age-year-space covariance

The simulation applied in this paper was set-up to control covariance across ages, years and space. To do this we used a combination of MatÃ©rn covariance, to control the level of spatial aggregation, and the age-year covariance described in Cadigan [-@Cadigan2016], to control the level of similarity in distributions across ages and years. As described in Appendix A in Cadigan [-@Cadigan2016], the age-year covariance can be broken down into a series of AR(1) processes. We integrate MatÃ©rn covariance into this series of equations:

$$\xi_{a,y,s} \sim \left\{\begin{matrix} MVN\left (0, \frac{\sigma_\xi^2}{(1 - \varphi_{age}^2)(1 - \varphi_{year}^2)} \boldsymbol{R}_s \right ) & a = 1, y = 1 & \\  MVN\left (\varphi_{year} \xi_{1, y - 1, s}, \frac{\sigma_\xi^2}{(1 - \varphi_{age}^2)} \boldsymbol{R}_s \right ) & a = 1, y > 1 & \\ MVN\left (\varphi_{age} \xi_{a - 1, 1, s}, \frac{\sigma_\xi^2}{(1 - \varphi_{year}^2)} \boldsymbol{R}_s \right ) & a > 1, y = 1 & \\ MVN\left (\varphi_{year} \xi_{a, y - 1, s} + \varphi_{age} (\xi_{a - 1, y, s} - \varphi_{year} \xi_{a - 1, y - 1, s}), \sigma_\xi^2 \boldsymbol{R}_s \right ) & a > 1, y > 1 & \end{matrix}\right.$$

Where $MVN$ indicates the multivariate normal distribution, $\sigma_\xi^2$ controls the variance of the process, $\varphi_{\xi, age}$ and $\varphi_{\xi, year}$ control correlation in the age and year dimension and $\boldsymbol{R}_s$ is defined by MatÃ©rn correlation:

$$\boldsymbol{R}_s = \frac{2^{1-\lambda}}{\Gamma(\lambda)} (\kappa \left |s_i - s_j \right|) K_{\lambda}(\kappa \left |s_i - s_j \right|)$$
where $\left |s_i - s_j \right|$ is the Euclidean distance between two locations, $\Gamma$ is the gamma function, $K_{\lambda}$ denotes the modified Bessel function of the second kind, and $\lambda$ and $\kappa$ control the smoothness and scale of the spatial process [@Blangiardo2015]. With this structure, simulated error is correlated across ages, years and space.

<br>

# References




































